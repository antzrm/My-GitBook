---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# FW Evasion

{% code overflow="wrap" fullWidth="true" %}
```
https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml
Next-Gen FW: Juniper SRX series and Cisco Firepower.
Cloud Firewall or FWaaS: Cloudflare Magic Firewall, Juniper vSRX, AWS WAF, AWS Shield
```
{% endcode %}

## Controlling the Source MAC/IP/Port

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Decoy(s) -> ME is our source IP so we can include some specific decoy IPs or random IPs
nmap -sS -Pn -D 10.10.10.1,10.10.10.2,ME -F MACHINE_IP
nmap -sS -Pn -D RND,RND,ME -F MACHINE_IP
# Proxy
nmap -sS -Pn --proxies PROXY_URL -F MACHINE_IP
# Spoofed MAC Address -> works only if your system is on the same network segment as the target host
nmap ... --spoof-mac MAC_ADDRESS
# Spoofed IP Address -> useful if your system is on the same subnetwork as the target host
nmap ... -S IP_ADDRESS
# Fixed Source Port Number -> helpful if you discover that FW allow incoming packets from particular source port numbers, such as port 53 or 80
nmap -sS -Pn -g 8080 -F MACHINE_IP
```
{% endcode %}

## Forcing Fragmentation, MTU, and Data Length

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Fragment Your Packets with 8 Bytes of Data
nmap -sS -Pn -f -F MACHINE_IP
# Fragment Your Packets with 16 Bytes of Data
nmap -sS -Pn -ff -F MACHINE_IP
# Fragment Your Packets According to a Set MTU -> number of bytes per IP packet (multiple of 8)
nmap -sS -Pn --mtu 8 -F MACHINE_IP
# Generate Packets with Specific Length -> might find out that the size of the packets is triggering the firewall
nmap -sS -Pn --data-length 64 -F MACHINE_IP
```
{% endcode %}

## Modifying Header Fields

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Set TTL -> might be useful if you think the default TTL exposes your port scan activities
nmap -sS -Pn --ttl 81 -F 10.10.91.188
# Set IP Options -> if you want to try to make your packets take a particular route to avoid a specific security system
--ip-options HEX_STRING
Simply pass the letter R, T, or U to request record-route, record-timestamp, or both options together, respectively. Loose or strict source routing may be specified with an L or S followed by a space and then a space-separated list of IP addresses.
# Use a Wrong Checksum -> some systems drop those packets and others don't so it's good to discover more about that system
nmap -sS -Pn --badsum -F 10.10.91.188
```
{% endcode %}

## Port Hopping&#x20;

Try to connect to different ports until we find one not blocked by FW

## Port Tunneling using ncat

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Example: SMTP server listening on port 25 but FW blocks that destination port. We discover packets sent to port 443 are not blocked
ncat -lvnp 443 -c "ncat TARGET_SERVER 25"
As a result, ncat will listen on port 443, but it will forward all packets to port 25 on the target server. Because in this case, the firewall is blocking port 25 and allowing port 443, port tunneling is an efficient way to evade the firewall.
# Web server example to access 8008 if 80 is blocked by FW
Victim>  ncat -lvnp 8008 -c "ncat 127.0.0.1 80"
AttackerBrowser> visit http://$VICTIM_IP:8008
```
{% endcode %}

## Next-Generation Firewalls

* Integrate a firewall and a real-time Intrusion Prevention System (IPS). It can stop any detected threat in real-time.
* Identify users and their traffic. It can enforce the security policy per-user or per-group basis.
* Identify the applications and protocols regardless of the port number being used.
* Identify the content being transmitted. It can enforce the security policy in case any violating content is detected.
* Ability to decrypt SSL/TLS and SSH traffic. For instance, it restricts evasive techniques built around encryption to transfer malicious files.
